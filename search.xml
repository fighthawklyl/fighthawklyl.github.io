<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>udhcpc6嵌入式获取IPV6</title>
      <link href="/2023/08/02/udhcpc6-qian-ru-shi-huo-qu-ipv6/"/>
      <url>/2023/08/02/udhcpc6-qian-ru-shi-huo-qu-ipv6/</url>
      
        <content type="html"><![CDATA[<h4 id="获取命令"><a href="#获取命令" class="headerlink" title="获取命令"></a>获取命令</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">udhcpc6 -b -i -eth0<span class="token comment"># -s 可以指定dhcpc的脚本文件路径</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="default-script"><a href="#default-script" class="headerlink" title="default.script"></a>default.script</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">RESOLV_CONF</span><span class="token operator">=</span><span class="token string">"/etc/resolv.conf"</span><span class="token punctuation">[</span> -n <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span> <span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:Error: should be called from udhcpc"</span><span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token assign-left variable">NETMASK</span><span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">[</span> -n <span class="token string">"<span class="token variable">$subnet</span>"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">NETMASK</span><span class="token operator">=</span><span class="token string">"netmask <span class="token variable">$subnet</span>"</span><span class="token assign-left variable">BROADCAST</span><span class="token operator">=</span><span class="token string">"broadcast +"</span><span class="token punctuation">[</span> -n <span class="token string">"<span class="token variable">$broadcast</span>"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">BROADCAST</span><span class="token operator">=</span><span class="token string">"broadcast <span class="token variable">$broadcast</span>"</span><span class="token keyword">case</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token keyword">in</span>deconfig<span class="token punctuation">)</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:Setting IP address 0.0.0.0 on <span class="token variable">$interface</span>"</span><span class="token comment">#ifconfig $interface 0.0.0.0</span><span class="token punctuation">;</span><span class="token punctuation">;</span>renew<span class="token operator">|</span>bound<span class="token punctuation">)</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:Setting IP address <span class="token variable">$ipv6</span> on <span class="token variable">$interface</span>"</span><span class="token function">ifconfig</span> <span class="token variable">$interface</span> <span class="token variable">$ipv6</span> <span class="token variable">$NETMASK</span> <span class="token variable">$BROADCAST</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$interface</span> <span class="token operator">!=</span> <span class="token string">"eth0"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span> <span class="token variable">$interface</span> <span class="token operator">!=</span> <span class="token string">"bond0"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span> <span class="token variable">$interface</span> <span class="token operator">!=</span> <span class="token string">"wlan0"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:<span class="token variable">$interface</span> is not allowd set router"</span><span class="token builtin class-name">exit</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:set router for <span class="token variable">$interface</span>"</span><span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span> -n <span class="token string">"<span class="token variable">$router</span>"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:Deleting routers"</span><span class="token keyword">while</span> route del default gw <span class="token number">0.0</span>.0.0 dev <span class="token variable">$interface</span> <span class="token punctuation">;</span> <span class="token keyword">do</span><span class="token builtin class-name">:</span><span class="token keyword">done</span><span class="token assign-left variable">metric</span><span class="token operator">=</span><span class="token number">0</span><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable">$router</span> <span class="token punctuation">;</span> <span class="token keyword">do</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:Adding router <span class="token variable">$i</span>"</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$subnet</span>"</span> <span class="token operator">=</span> <span class="token string">"255.255.255.255"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token comment"># special case for /32 subnets:</span><span class="token comment"># /32 instructs kernel to always use routing for all outgoing packets</span><span class="token comment"># (they can never be sent to local subnet - there is no local subnet for /32).</span><span class="token comment"># Used in datacenters, avoids the need for private ip-addresses between two hops.</span><span class="token function">ip</span> route <span class="token function">add</span> <span class="token variable">$i</span> dev <span class="token variable">$interface</span><span class="token keyword">fi</span>route <span class="token function">add</span> default gw <span class="token variable">$i</span> dev <span class="token variable">$interface</span> metric <span class="token variable"><span class="token variable">$((</span>metric<span class="token operator">++</span><span class="token variable">))</span></span><span class="token keyword">done</span><span class="token keyword">fi</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc:Recreating <span class="token variable">$RESOLV_CONF</span>"</span><span class="token assign-left variable">tmpfile</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$RESOLV_CONF</span>"</span><span class="token operator">></span> <span class="token string">"<span class="token variable">$tmpfile</span>"</span><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable">$dns</span> <span class="token punctuation">;</span> <span class="token keyword">do</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc: Adding DNS server <span class="token variable">$i</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"nameserver <span class="token variable">$i</span>"</span> <span class="token operator">>></span> <span class="token string">"<span class="token variable">$tmpfile</span>"</span><span class="token keyword">done</span><span class="token function">mv</span> <span class="token string">"<span class="token variable">$tmpfile</span>"</span> <span class="token string">"<span class="token variable">$RESOLV_CONF</span>"</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token keyword">esac</span><span class="token builtin class-name">exit</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> 网络 </tag>
            
            <tag> udhcpc6 </tag>
            
            <tag> ipv6 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IPV6服务器搭建</title>
      <link href="/2023/08/02/ipv6-fu-wu-qi-da-jian/"/>
      <url>/2023/08/02/ipv6-fu-wu-qi-da-jian/</url>
      
        <content type="html"><![CDATA[<h3 id="IPV6服务器搭建"><a href="#IPV6服务器搭建" class="headerlink" title="IPV6服务器搭建"></a>IPV6服务器搭建</h3><p>搭建环境：ubuntu<br>使用工具：isc-dhcp-server、radvd</p><h4 id="一、虚拟机配置"><a href="#一、虚拟机配置" class="headerlink" title="一、虚拟机配置"></a>一、虚拟机配置</h4><p><img "" class="lazyload placeholder" data-original="/photo/ipv6server/ubuntuNetSet.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>虚拟机需要配置网络为桥接。<br>主要目的是为了，让该虚拟机能给所在的局域网设备自动分配ipv6</p><h4 id="二、isc-dhcp-server工具安装"><a href="#二、isc-dhcp-server工具安装" class="headerlink" title="二、isc-dhcp-server工具安装"></a>二、isc-dhcp-server工具安装</h4><p>dhcpd工具主要用于和udhcpc6交互，分配ipv6给客户端<br>1、安装isc-dhcp-server工具</p><p>```bash<br>sudo apt update<br>sudo apt install isc-dhcp-server</p><pre class="line-numbers language-none"><code class="language-none">&#96;&#96;&#96;&#96;bash#安装过程可能会看到因为一些什么奇怪的锁,如下所示,可以根据提示kill掉对应的进程或者强制解锁直接删除文件。Unable to acquire the dpkg frontend lock#杀掉占用的进程sudo kill PID#强制解锁sudo rm &#x2F;var&#x2F;cache&#x2F;apt&#x2F;archives&#x2F;locksudo rm &#x2F;var&#x2F;lib&#x2F;dpkg&#x2F;lock<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2、配置dhcpd配置文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#打开/etc/dhcp/dhcpd6.conf文件，若没有则创建</span><span class="token comment">#打开该文件的时候可能会遇到文件只读无法写使用下面命令即可</span><span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">777</span> /etc/dhcp/dhcpd6.conf<span class="token comment">#dhcpd6.conf配置</span><span class="token comment"># Server configuration file example for DHCPv6</span><span class="token comment"># From the file used for TAHI tests - addresses chosen</span><span class="token comment"># to match TAHI rather than example block.</span><span class="token comment"># IPv6 address valid lifetime</span><span class="token comment">#  (at the end the address is no longer usable by the client)</span><span class="token comment">#  (set to 30 days, the usual IPv6 default)</span>default-lease-time <span class="token number">2592000</span><span class="token punctuation">;</span><span class="token comment"># IPv6 address preferred lifetime</span><span class="token comment">#  (at the end the address is deprecated, i.e., the client should use</span><span class="token comment">#   other addresses for new connections)</span><span class="token comment">#  (set to 7 days, theusual IPv6 default)</span>preferred-lifetime <span class="token number">604800</span><span class="token punctuation">;</span><span class="token comment"># T1, the delay before Renew</span><span class="token comment">#  (default is 1/2 preferred lifetime)</span><span class="token comment">#  (set to 1 hour)</span>option dhcp-renewal-time <span class="token number">3600</span><span class="token punctuation">;</span><span class="token comment"># T2, the delay before Rebind (if Renews failed)</span><span class="token comment">#  (default is 3/4 preferred lifetime)</span><span class="token comment">#  (set to 2 hours)</span>option dhcp-rebinding-time <span class="token number">7200</span><span class="token punctuation">;</span><span class="token comment"># Enable RFC 5007 support (same than for DHCPv4)</span>allow leasequery<span class="token punctuation">;</span><span class="token comment"># Global definitions for name server address(es) and domain search list</span>option dhcp6.name-servers 3ffe:501:ffff:100:200:ff:fe00:3f3e<span class="token punctuation">;</span>option dhcp6.domain-search <span class="token string">"test.example.com"</span>,<span class="token string">"example.com"</span><span class="token punctuation">;</span><span class="token comment"># Set preference to 255 (maximum) in order to avoid waiting for</span><span class="token comment"># additional servers when there is only one</span><span class="token comment">##option dhcp6.preference 255;</span><span class="token comment"># Server side command to enable rapid-commit (2 packet exchange)</span><span class="token comment">##option dhcp6.rapid-commit;</span><span class="token comment"># The delay before information-request refresh</span><span class="token comment">#  (minimum is 10 minutes, maximum one day, default is to not refresh)</span><span class="token comment">#  (set to 6 hours)</span>option dhcp6.info-refresh-time <span class="token number">21600</span><span class="token punctuation">;</span><span class="token comment"># Static definition (must be global)</span><span class="token comment">#host myclient &#123;</span><span class="token comment">## The entry is looked up by this</span><span class="token comment">#host-identifier option</span><span class="token comment">#dhcp6.client-id 00:01:00:01:00:04:93:e0:00:00:00:00:a2:a2;</span><span class="token comment">#</span><span class="token comment">## A fixed address</span><span class="token comment">#fixed-address6 3ffe:501:ffff:100::1234;</span><span class="token comment">#</span><span class="token comment">## A fixed prefix</span><span class="token comment">#fixed-prefix6 3ffe:501:ffff:101::/64;</span><span class="token comment">#</span><span class="token comment">## Override of the global definitions,</span><span class="token comment">## works only when a resource (address or prefix) is assigned</span><span class="token comment">#option dhcp6.name-servers 3ffe:501:ffff:100:200:ff:fe00:4f4e;</span><span class="token comment">#</span><span class="token comment">## For debug (to see when the entry statements are executed)</span><span class="token comment">##  (log "sol" when a matching Solicitation is received)</span><span class="token comment">###if packet(0,1) = 1 &#123; log(debug,"sol"); &#125;</span><span class="token comment">#&#125;</span><span class="token comment">#</span><span class="token comment">#host otherclient &#123;</span><span class="token comment">#        # This host entry is hopefully matched if the client supplies a DUID-LL</span><span class="token comment">#        # or DUID-LLT containing this MAC address.</span><span class="token comment">#        hardware ethernet 01:00:80:a2:55:67;</span><span class="token comment">#</span><span class="token comment">#        fixed-address6 3ffe:501:ffff:100::4321;</span><span class="token comment">#&#125;</span>subnet6 <span class="token number">2001</span>:db8:1:0::/64 <span class="token punctuation">&#123;</span>range6 <span class="token number">2001</span>:db8:1:0::50 <span class="token number">2001</span>:db8:1:0::100<span class="token punctuation">;</span>option dhcp6.name-servers <span class="token number">2001</span>:4860:4860::8888<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment"># The subnet where the server is attached</span><span class="token comment">#  (i.e., the server has an address in this subnet)</span><span class="token comment">#subnet6 3ffe:501:ffff:100::/64 &#123;</span><span class="token comment">## Two addresses available to clients</span><span class="token comment">##  (the third client should get NoAddrsAvail)</span><span class="token comment">#range6 3ffe:501:ffff:100::10 3ffe:501:ffff:100::11;</span><span class="token comment">#</span><span class="token comment">## Use the whole /64 prefix for temporary addresses</span><span class="token comment">##  (i.e., direct application of RFC 4941)</span><span class="token comment">#range6 3ffe:501:ffff:100:: temporary;</span><span class="token comment">#</span><span class="token comment">## Some /64 prefixes available for Prefix Delegation (RFC 3633)</span><span class="token comment">#prefix6 3ffe:501:ffff:100:: 3ffe:501:ffff:111:: /64;</span><span class="token comment">#&#125;</span><span class="token comment"># A second subnet behind a relay agent</span><span class="token comment">#subnet6 3ffe:501:ffff:101::/64 &#123;</span><span class="token comment">#range6 3ffe:501:ffff:101::10 3ffe:501:ffff:101::11;</span><span class="token comment">#</span><span class="token comment">## Override of the global definitions,</span><span class="token comment">## works only when a resource (address or prefix) is assigned</span><span class="token comment">#option dhcp6.name-servers 3ffe:501:ffff:101:200:ff:fe00:3f3e;</span><span class="token comment">#</span><span class="token comment">#&#125;</span><span class="token comment"># A third subnet behind a relay agent chain</span><span class="token comment">#subnet6 3ffe:501:ffff:102::/64 &#123;</span><span class="token comment">#range6 3ffe:501:ffff:102::10 3ffe:501:ffff:102::11;</span><span class="token comment">#&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="三、radvd工具安装"><a href="#三、radvd工具安装" class="headerlink" title="三、radvd工具安装"></a>三、radvd工具安装</h4><p>radvd工具主要用于广播网关</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> radvd<span class="token comment">#创建/etc/radvd.conf，若有则无需创建</span><span class="token comment">#添加读写权限</span><span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">777</span> /etc/radvd.conf<span class="token comment">#配置/etc/radvd.conf文件</span>interface ens33<span class="token punctuation">&#123;</span>AdvSendAdvert on<span class="token punctuation">;</span>MinRtrAdvInterval <span class="token number">30</span><span class="token punctuation">;</span>MaxRtrAdvInterval <span class="token number">600</span><span class="token punctuation">;</span>AdvManagedFlag on<span class="token punctuation">;</span>AdvOtherConfigFlag on<span class="token punctuation">;</span>AdvLinkMTU <span class="token number">1500</span><span class="token punctuation">;</span>AdvSourceLLAddress on<span class="token punctuation">;</span>AdvDefaultPreference high<span class="token punctuation">;</span>prefix <span class="token number">2001</span>:db8:1:0::/64<span class="token punctuation">&#123;</span>AdvOnLink on<span class="token punctuation">;</span>AdvAutonomous off<span class="token punctuation">;</span>AdvRouterAddr on<span class="token punctuation">;</span>AdvPreferredLifetime <span class="token number">3600</span><span class="token punctuation">;</span>AdvValidLifetime <span class="token number">7200</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>route <span class="token number">2001</span>:db8:1:0::/64<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>####四、启动服务<br>1、启动radvd服务</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">service</span> radvd start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/ipv6server/radvd.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="radvd启动成功"><br>2、启动dhcpd服务</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#设置ubuntu的ipv6 ip</span><span class="token function">sudo</span> <span class="token function">ifconfig</span> ens33 inet6 <span class="token function">add</span> <span class="token number">2001</span>:db8:1:0::1/64<span class="token comment">#启动dhcpd</span><span class="token function">sudo</span> dhcpd -6 -d -cf /etc/dhcp/dhcpd6.conf ens33<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/ipv6server/dhcpd6.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="启动过程及分配ipv6打印"></p>]]></content>
      
      
      <categories>
          
          <category> 网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> 网络 </tag>
            
            <tag> ipv6 </tag>
            
            <tag> dhcpd </tag>
            
            <tag> radvd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux usb设备数量和类型识别</title>
      <link href="/2022/07/16/linux-usb-she-bei-shu-liang-he-lei-xing-shi-bie/"/>
      <url>/2022/07/16/linux-usb-she-bei-shu-liang-he-lei-xing-shi-bie/</url>
      
        <content type="html"><![CDATA[<h4 id="一、整体思路"><a href="#一、整体思路" class="headerlink" title="一、整体思路"></a>一、整体思路</h4><p>1、获取 /sys/bus/usb/devices 目录下文件信息。如下所示<br><img "" class="lazyload placeholder" data-original="/photo/usbinfo/1.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>2、例如 1-1 usb设备信息，可以通过命令ls 1-1查看 </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> <span class="token number">1</span>-1<span class="token number">1</span>-1:1.0              bmAttributes         manufacturerauthorized           busnum               maxchildavoid_reset_quirk    configuration        portbConfigurationValue  descriptors          productbDeviceClass         dev                  quirksbDeviceProtocol      devnum               removablebDeviceSubClass      devpath              removebMaxPacketSize0      driver               speedbMaxPower            ep_00                subsystembNumConfigurations   idProduct            ueventbNumInterfaces       idVendor             urbnumbcdDevice            ltm_capable          version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/usbinfo/2.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>其中product中就是该usb设备类型<br>3、获取usb设备类型</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /1-1/productAltoBeam_WIFI<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/usbinfo/3.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>返回显示该设备是一个usb wifi。</p><p>因此要知道设备上的usb设备数量以及类型就需要对这些文件进行读取。</p><h4 id="二、代码实现"><a href="#二、代码实现" class="headerlink" title="二、代码实现"></a>二、代码实现</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYS_USB_INFO</span>  <span class="token string">"/sys/bus/usb/devices"</span></span><span class="token keyword">static</span> UsbType_s g_astUsbType<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    XM_CHAR aPort<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    XM_CHAR aType<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> UsbType_s<span class="token punctuation">;</span><span class="token comment">//获取usb设备类型,成功返回 0 ；失败返回 -1；</span><span class="token keyword">static</span> XM_S32 <span class="token function">Usb_getState</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> pPath<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> pType<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    DIR <span class="token operator">*</span>pstDir <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">stat</span> ststat<span class="token punctuation">;</span>        <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span>pstDirent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    XM_CHAR aFileName<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    XM_S32 fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    XM_S32 ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        pstDir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>pPath<span class="token punctuation">)</span><span class="token punctuation">;</span>    pstDirent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pstDirent<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"product"</span><span class="token punctuation">,</span>pstDirent<span class="token operator">-></span>d_name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>aFileName<span class="token punctuation">,</span>pPath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>aFileName<span class="token punctuation">,</span><span class="token string">"/product"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>aFileName<span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">stat</span><span class="token punctuation">(</span>aFileName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ststat<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> pType<span class="token punctuation">,</span>ststat<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">&#123;</span>                    ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        pstDirent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">closedir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> ret<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//获取usb接口设备连接数以及设备类型</span><span class="token comment">//有usb设备返回0，失败返回-1,pNum返回usb设备个数，ppstUsbType是usb设备信息</span>XM_S32 <span class="token function">LibXmDvr_Usb_getState</span><span class="token punctuation">(</span>XM_S32 <span class="token operator">*</span>pNum<span class="token punctuation">,</span>UsbType_s<span class="token operator">*</span><span class="token operator">*</span> ppstUsbType<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    DIR <span class="token operator">*</span>pstDir<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span>pstDirent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    XM_CHAR aPath<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    XM_CHAR aType<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    XM_S32 index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    pstDir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>SYS_USB_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>    pstDirent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pstDirent<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>         <span class="token function">memset</span><span class="token punctuation">(</span>aPath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>aPath<span class="token punctuation">,</span>SYS_USB_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcat</span><span class="token punctuation">(</span>aPath<span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcat</span><span class="token punctuation">(</span>aPath<span class="token punctuation">,</span>pstDirent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">memset</span><span class="token punctuation">(</span>aType<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">Usb_getState</span><span class="token punctuation">(</span>aPath<span class="token punctuation">,</span>aType<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> index <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>aType<span class="token punctuation">,</span><span class="token string">"usbhc-nvtivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                pstDirent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>g_astUsbType<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>aPort<span class="token punctuation">,</span>pstDirent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>g_astUsbType<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>aType<span class="token punctuation">,</span>aType<span class="token punctuation">)</span><span class="token punctuation">;</span>            index<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        pstDirent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token function">closedir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span>pNum <span class="token operator">=</span> index<span class="token punctuation">;</span>    <span class="token operator">*</span>ppstUsbType <span class="token operator">=</span> g_astUsbType<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>index <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>index <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> linux </tag>
            
            <tag> usb </tag>
            
            <tag> 目录获取 </tag>
            
            <tag> readdir </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>命令读写寄存器</title>
      <link href="/2022/06/30/ming-ling-du-xie-ji-cun-qi/"/>
      <url>/2022/06/30/ming-ling-du-xie-ji-cun-qi/</url>
      
        <content type="html"><![CDATA[<h4 id="一、devmem"><a href="#一、devmem" class="headerlink" title="一、devmem"></a>一、devmem</h4><p>读寄存器 0xfc203000</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">devmem  寄存器地址  数据长度（最大64位）devmem  0xfc203000  <span class="token number">32</span>0x11a2e291<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>写寄存器</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">devmem  寄存器地址  数据长度  要写入数据devmem  0xfc203000  <span class="token number">32</span>  0xaa12e2f5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="二、himm海思工具"><a href="#二、himm海思工具" class="headerlink" title="二、himm海思工具"></a>二、himm海思工具</h4><p>读寄存器 0xfc203000</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">himm  寄存器地址  himm  0xfc203000 0x11a2e291<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>写寄存器</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">himm  寄存器地址   要写入数据himm  0xfc203000  0xaa12e2f5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> devmem </tag>
            
            <tag> 读写寄存器 </tag>
            
            <tag> himm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>curl交叉编译</title>
      <link href="/2022/06/19/curl-jiao-cha-bian-yi/"/>
      <url>/2022/06/19/curl-jiao-cha-bian-yi/</url>
      
        <content type="html"><![CDATA[<h4 id="一、下载curl源码"><a href="#一、下载curl源码" class="headerlink" title="一、下载curl源码"></a>一、下载curl源码</h4><p><a href="https://curl.se/download/">curl官网</a></p><h4 id="二、交叉编译"><a href="#二、交叉编译" class="headerlink" title="二、交叉编译"></a>二、交叉编译</h4><h5 id="1、解压"><a href="#1、解压" class="headerlink" title="1、解压"></a>1、解压</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> -xzvf curl-7.82.0.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="2、配置交叉编译"><a href="#2、配置交叉编译" class="headerlink" title="2、配置交叉编译"></a>2、配置交叉编译</h4><p>以联咏NT98331平台为例</p><div class="note info"><p>–prefix 指定编译安装目录</p></div><div class="note info"><p>–disable-threaded-resolver 应该和线程有关，安装时报了 Threaded resolver enabled butno thread library found 这个错，所以禁用了} {% note info</p></div><div class="note info"><p>–with-ssl 指定ssl目录。</p></div><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure --target<span class="token operator">=</span>arm-ca53-linux --host<span class="token operator">=</span>arm-ca53-linux  --prefix<span class="token operator">=</span>/home/liyongli/SVN/curl331 --disable-threaded-resolver <span class="token assign-left variable">CC</span><span class="token operator">=</span>arm-ca53-linux-uclibcgnueabihf-novatek-8.4-gcc --with-ssl<span class="token operator">=</span>/home/liyongli/SVN/openssl331 --enable-static  -disable-dict --disable-ftp --disable-imap --disable-ldap --disable-ldaps --disable-pop3 --disable-proxy --disable-rtsp --disable-smtp --disable-telnet --disable-tftp --disable-zlib --without-ca-bundle --without-gnutls --without-libidn --without-librtmp --without-libssh2 --without-nss --without-zlib<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>配置完成，编译</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这样编译是动态库链接编译，如果需要静态编译，得到不依赖库，的可执行curl工具还需要修改文件<br>修改 curl-7.82.0/Makefile 和 curl-7.82.0/src/Makefile文件中,CFLAGS编译参数添加-static -static-libgcc</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">CFLAGS <span class="token operator">=</span> -Werror-implicit-function-declaration -O2 -Wno-system-headers -static -static-libgcc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>还需要删除编译出来openssl库中的动态库，既可以静态编译curl可执行程序。</p><p><a href="https://marysufer.com/2022/06/18/openssl-jiao-cha-bian-yi/">opessl交叉编译</a></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> 交叉编译 </tag>
            
            <tag> curl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openssl交叉编译</title>
      <link href="/2022/06/18/openssl-jiao-cha-bian-yi/"/>
      <url>/2022/06/18/openssl-jiao-cha-bian-yi/</url>
      
        <content type="html"><![CDATA[<h4 id="一、下载openssl源码"><a href="#一、下载openssl源码" class="headerlink" title="一、下载openssl源码"></a>一、下载openssl源码</h4><p><a href="">github3.0.1版本</a><br><a href="https://www.openssl.org/">openssl官网</a><br><img "" class="lazyload placeholder" data-original="/photo/openssl/1.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br><img "" class="lazyload placeholder" data-original="/photo/openssl/2.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><h4 id="二、交叉编译"><a href="#二、交叉编译" class="headerlink" title="二、交叉编译"></a>二、交叉编译</h4><h5 id="1、解压"><a href="#1、解压" class="headerlink" title="1、解压"></a>1、解压</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> -xzvf openssl-3.0.1.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="2、配置交叉编译"><a href="#2、配置交叉编译" class="headerlink" title="2、配置交叉编译"></a>2、配置交叉编译</h5><p>以联咏NT98331平台为例</p><div class="note info"><p>no-asm 关于汇编的模块不进行编译</p></div><div class="note info"><p>shared 编译成动态链接库</p></div><div class="note info"><p>no-async 不编译异步相关函数</p></div><div class="note info"><p>–prefix 指定编译结果目录即安装目录</p></div><div class="note info"><p>–cross-compile-prefix 指定交叉编译器及其路径，下面是交叉编译器已经再环境变量申明</p></div><div class="note info"><p>CC 配置编译器</p></div><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./Configure no-asm shared no-async --prefix<span class="token operator">=</span>/home/liyongli/SVN/openssl331 --cross-compile-prefix<span class="token operator">=</span>arm-ca53-linux-uclibcgnueabihf-novatek-8.4- <span class="token assign-left variable">CC</span><span class="token operator">=</span>gcc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>配置完成<br><img "" class="lazyload placeholder" data-original="/photo/openssl/3.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><p>打开Makefile，删除 -m64<br><img "" class="lazyload placeholder" data-original="/photo/openssl/4.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><p>先后执行make 和 make install即可完成编译</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span><span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> 交叉编译 </tag>
            
            <tag> openssl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iptables网络共享</title>
      <link href="/2022/04/13/iptables-wang-luo-gong-xiang/"/>
      <url>/2022/04/13/iptables-wang-luo-gong-xiang/</url>
      
        <content type="html"><![CDATA[<h2 id="实现在嵌入式平台内网共享"><a href="#实现在嵌入式平台内网共享" class="headerlink" title="实现在嵌入式平台内网共享"></a>实现在嵌入式平台内网共享</h2><p>A设备有外网<br>B设备无外网<br>使用iptables nat转发，实现A设备给B设备提供网络</p><h3 id="一、内核添加iptables选项支持"><a href="#一、内核添加iptables选项支持" class="headerlink" title="一、内核添加iptables选项支持"></a>一、内核添加iptables选项支持</h3><p>按照下图中选项配置内核iptables支持。<br><img "" class="lazyload placeholder" data-original="/photo/iptables/kernel_1.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br><img "" class="lazyload placeholder" data-original="/photo/iptables/kernel_2.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br><img "" class="lazyload placeholder" data-original="/photo/iptables/kernel_3.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><h3 id="二、iptables工具编译"><a href="#二、iptables工具编译" class="headerlink" title="二、iptables工具编译"></a>二、iptables工具编译</h3><p>示例中选择的时iptables1.6.2版本。(<a href="https://www.netfilter.org/">iptables源码下载</a>)</p><p><font color='red'> 注意：需要修改 configure文件中文件地址,否则使用时可能出现 “Fatal: can’t open lock file /run/xtables.lock: No such file or directory”报。<br>        旧：xt_lock_name=”/run/xtables.lock”<br>        新：xt_lock_name=”/mnt/mtd/xtables.lock”</font> </p><p>交叉编译命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure --prefix<span class="token operator">=</span>/home/lyl/SVN/iptables16 --host<span class="token operator">=</span>arm-ca9-linux <span class="token assign-left variable">CC</span><span class="token operator">=</span>arm-ca9-linux-uclibcgnueabihf-gcc  --disable-nftables<span class="token function">make</span><span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>–prefix=/home/lyl/SVN/iptables16配置的是编译后的文件保存路径</p><p>CC=arm-ca9-linux-uclibcgnueabihf-gcc配置NT98321交叉编译器</p><p>–disable-nftables 去除该选项，不去除可能会存在如下报错</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">checking <span class="token keyword">for</span> libmnl<span class="token punctuation">..</span>. no*** Error: No suitable libmnl found. ***    Please <span class="token function">install</span> the <span class="token string">'libmnl'</span> package    Or consider --disable-nftables to skip    iptables-compat over nftables support.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="三、iptales-nat转发"><a href="#三、iptales-nat转发" class="headerlink" title="三、iptales nat转发"></a>三、iptales nat转发</h3><h4 id="1、配置环境变量"><a href="#1、配置环境变量" class="headerlink" title="1、配置环境变量"></a>1、配置环境变量</h4><p>将iptales编译完成的bin目录下文件打包倒usr/sbin文件目录下，将lib文件打包倒usr/lib目录下。添加环境变量。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">XTABLES_LIBDIR</span><span class="token operator">=</span>/usr/lib/xtables<span class="token builtin class-name">export</span> <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span>/usr/local/lib:/usr/lib<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><font color='red'>如果没有给环境变量可能会导致iptables 一些操作命令无法正常使用，遇到过 –to-source 的报错</font> </p><h4 id="2、配置设备ip"><a href="#2、配置设备ip" class="headerlink" title="2、配置设备ip"></a>2、配置设备ip</h4><p>A设备：eth3为usb 4g模块上网，eth0有线网口,假设4g的ip为10.24.131.49<br>B设备：eth0有线网口</p><p>A设备ip配置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">netinit <span class="token number">192.168</span>.2.1 <span class="token number">255.255</span>.255.0 <span class="token number">192.168</span>.2.254<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>B设备ip配置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">netinit <span class="token number">192.168</span>.2.3 <span class="token number">255.255</span>.255.0 <span class="token number">192.168</span>.2.254<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><a href="https://wangchujiang.com/linux-command/c/iptables.html#%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6">iptables命令使用详解</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 打开linux内核的nat转发功能</span><span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/net/ipv4/ip_forward<span class="token comment">#SNAT源地址转换，将来自B设备在这个ip范围内 192.168.2.2/24的地址转换为10.24.131.49</span>iptables -t nat -A POSTROUTING -s <span class="token number">192.168</span>.2.2/24 -o eth3 -j SNAT --to-source <span class="token number">10.24</span>.131.49或（4g 5gip可能会发生变化不固定，让系统自动获取ip）iptables -t nat -A POSTROUTING -s <span class="token number">192.168</span>.2.2/24  -o eth3 -j MASQUERADE<span class="token comment">#上网控制，允许192.168.2.1/24范围的ip访问网络</span>iptables -A FORWARD -s <span class="token number">192.168</span>.2.1/24 -j ACCEPT<span class="token comment">#在B设备</span><span class="token function">ping</span> <span class="token number">192.168</span>.2.1  （ping网关能通）<span class="token function">ping</span> www.baidu.com <span class="token punctuation">(</span>可能存在无法ping通，可能由于dns解析配置文件导致，检查配置该 /etc/resolv.cond 文件<span class="token punctuation">)</span><span class="token comment">#在A设备，遇到过无法ping通B设备，原因可能是路由表导致，输入route命令，查看路由表</span><span class="token comment">#中显示的默认网关，B设备默认网关应当是192.168.2.1（gateway）,（flags）UG。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> iptables </tag>
            
            <tag> linux </tag>
            
            <tag> 网络 </tag>
            
            <tag> 内网共享 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>链式队列</title>
      <link href="/2021/07/17/lian-shi-dui-lie/"/>
      <url>/2021/07/17/lian-shi-dui-lie/</url>
      
        <content type="html"><![CDATA[<h3 id="链式队列"><a href="#链式队列" class="headerlink" title="链式队列"></a>链式队列</h3><p>链式队列–使用链表模拟实现队列先进先出，主要由一个一个数据节点连接而成。下面代码封装了两种模式队列<br>一、更具入队出队改变队列长度，动态分配内存，以及节点内存大小也是动态更具需要分配<br>二、初始化为定长，节点空间固定大小，连接成环形队列。</p><span id="more"></span><h3 id="图解两种模式队列"><a href="#图解两种模式队列" class="headerlink" title="图解两种模式队列"></a>图解两种模式队列</h3><div class="tabs" id="tab-id"><ul class="nav-tabs"><li class="tab active"><a class="#tab-id-1">动态分配内存</a></li><li class="tab"><a class="#tab-id-2">固定内存环形队列</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-id-1"><p><img "" class="lazyload placeholder" data-original="/photo/queue/init1.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="初始化"><br><img "" class="lazyload placeholder" data-original="/photo/queue/push1.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="入队"><br><img "" class="lazyload placeholder" data-original="/photo/queue/pop1.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="出队"></p></div><div class="tab-pane" id="tab-id-2"><p><img "" class="lazyload placeholder" data-original="/photo/queue/init2.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="初始化"><br><img "" class="lazyload placeholder" data-original="/photo/queue/push2.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="入队"><br><img "" class="lazyload placeholder" data-original="/photo/queue/pop2.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="出队"></p></div></div></div><div class="tabs" id="tab-id"><ul class="nav-tabs"><li class="tab active"><a class="#tab-id-1">queue.h</a></li><li class="tab"><a class="#tab-id-2">queue.c</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-id-1"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__QUEUE_PUBLIC_H__</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__QUEUE_PUBLIC_H__</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  Type<span class="token punctuation">;</span><span class="token comment">//链表节点</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">&#123;</span>Type<span class="token operator">*</span> buff<span class="token punctuation">;</span><span class="token class-name">size_t</span> len<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token operator">*</span> next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>Node<span class="token punctuation">;</span><span class="token comment">//链表</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">QueueList</span><span class="token punctuation">&#123;</span><span class="token class-name">pthread_mutex_t</span> mutex_lock<span class="token punctuation">;</span><span class="token comment">//互斥锁防止同时出队，和入队活着一个出队一个入队时出现不同步</span><span class="token class-name">size_t</span> res<span class="token punctuation">;</span><span class="token comment">//记录链表节点总个数</span><span class="token class-name">size_t</span> size<span class="token punctuation">;</span><span class="token comment">//记录每个节点buff空间大小</span>Node<span class="token operator">*</span> head<span class="token punctuation">;</span>Node<span class="token operator">*</span> tail<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>QueueList<span class="token punctuation">;</span><span class="token comment">//初始化链式队列</span><span class="token keyword">int</span> <span class="token function">queuelist_init</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span><span class="token operator">*</span> queue<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建节点</span>Node<span class="token operator">*</span> <span class="token function">node_create</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span>Type<span class="token operator">*</span> buff<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//队列为空</span><span class="token keyword">int</span> <span class="token function">is_qempty</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//队列满</span><span class="token keyword">int</span> <span class="token function">is_qfull</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//队列字符串个数</span><span class="token keyword">int</span> <span class="token function">queuelist_num</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//入队(尾添加)</span><span class="token keyword">int</span> <span class="token function">Push_QueueList</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span>Type<span class="token operator">*</span> buff<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//出队(头删除)</span><span class="token keyword">int</span> <span class="token function">Pop_QueueList</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span>Type<span class="token operator">*</span> buff<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清空队列中数据</span><span class="token keyword">void</span> <span class="token function">clean_queuelist</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//销毁队列</span><span class="token keyword">int</span> <span class="token function">destroy_queuelist</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span><span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><div class="tab-pane" id="tab-id-2"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"queue.h"</span></span><span class="token comment">//初始化链式队列，len，size 都为0创建变长队列，都不为0创建len长度，每个size大小的队列</span><span class="token keyword">int</span> <span class="token function">queuelist_init</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span><span class="token operator">*</span> queue<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> len <span class="token operator">&amp;&amp;</span> <span class="token number">0</span> <span class="token operator">==</span> size<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;</span> len <span class="token operator">&amp;&amp;</span> <span class="token number">0</span> <span class="token operator">&lt;</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token operator">*</span>queue <span class="token operator">=</span> <span class="token punctuation">(</span>QueueList<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>QueueList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> <span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"failed while malloc &lt;queuelist>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>mutex_lock<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"failed while MutexCreate\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>queue <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> len <span class="token operator">&amp;&amp;</span> <span class="token number">0</span> <span class="token operator">==</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">=</span> size<span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Node<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token function">node_create</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head <span class="token operator">&amp;&amp;</span> <span class="token constant">NULL</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head <span class="token operator">=</span> node<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail <span class="token operator">=</span> node<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail<span class="token operator">-></span>next <span class="token operator">=</span> node<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail <span class="token operator">=</span> node<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//创建节点 size == 0创建buff长度的节点，size> 0创建size长度的节点</span>Node<span class="token operator">*</span> <span class="token function">node_create</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span>Type<span class="token operator">*</span> buff<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Node<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token punctuation">(</span>Node<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> node<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"failed while malloc &lt;node>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> node<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>node<span class="token operator">-></span>buff <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> queue<span class="token operator">-></span>size<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>Type<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>Type<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>node<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>node<span class="token operator">-></span>len <span class="token operator">=</span> len<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">bzero</span><span class="token punctuation">(</span>node<span class="token operator">-></span>buff<span class="token punctuation">,</span>queue<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> node<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">memcpy</span><span class="token punctuation">(</span>node<span class="token operator">-></span>buff<span class="token punctuation">,</span>buff<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> node<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//队列为空</span><span class="token keyword">int</span> <span class="token function">is_qempty</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//perror("queue is NULLL\n");</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//队列满</span><span class="token keyword">int</span> <span class="token function">is_qfull</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"queue is NULL\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"queue type error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>res <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> queue<span class="token operator">-></span>size <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> queue<span class="token operator">-></span>head <span class="token operator">==</span> queue<span class="token operator">-></span>tail <span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//队列字符串个数</span><span class="token keyword">int</span> <span class="token function">queuelist_num</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"queue is NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> queue<span class="token operator">-></span>res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//入队(尾添加)</span><span class="token keyword">int</span> <span class="token function">Push_QueueList</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span>Type<span class="token operator">*</span> buff<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"push fail,queue is NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> buff<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"push fail,buff is NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> queue<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Node<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>node <span class="token operator">=</span> <span class="token function">node_create</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span>buff<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> node<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> queue<span class="token operator">-></span>head<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>queue<span class="token operator">-></span>head <span class="token operator">=</span> node<span class="token punctuation">;</span>queue<span class="token operator">-></span>tail <span class="token operator">=</span> node<span class="token punctuation">;</span>queue<span class="token operator">-></span>res<span class="token operator">++</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>queue<span class="token operator">-></span>tail<span class="token operator">-></span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>queue<span class="token operator">-></span>tail <span class="token operator">=</span> node<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">is_qfull</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"queue full\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">></span> queue<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buff too larger!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">memcpy</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>tail<span class="token operator">-></span>buff<span class="token punctuation">,</span>buff<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>queue<span class="token operator">-></span>tail<span class="token operator">-></span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>queue<span class="token operator">-></span>tail<span class="token operator">=</span>queue<span class="token operator">-></span>tail<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>queue<span class="token operator">-></span>res<span class="token operator">++</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//出队(头删除)</span><span class="token keyword">int</span> <span class="token function">Pop_QueueList</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span>Type<span class="token operator">*</span> buff<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pop fail,queue is NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">is_qempty</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pop fail,queue is empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>head<span class="token operator">-></span>len <span class="token operator">></span> len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buff is too samll!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> size<span class="token operator">=</span>queue<span class="token operator">-></span>head<span class="token operator">-></span>len<span class="token punctuation">;</span><span class="token function">memcpy</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span>queue<span class="token operator">-></span>head<span class="token operator">-></span>buff<span class="token punctuation">,</span>queue<span class="token operator">-></span>head<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">memset</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>head<span class="token operator">-></span>buff<span class="token punctuation">,</span><span class="token number">0x0</span><span class="token punctuation">,</span>queue<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>Node<span class="token operator">*</span> node <span class="token operator">=</span> queue<span class="token operator">-></span>head<span class="token punctuation">;</span>queue<span class="token operator">-></span>head<span class="token operator">-></span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>queue<span class="token operator">-></span>head <span class="token operator">=</span> queue<span class="token operator">-></span>head<span class="token operator">-></span>next<span class="token punctuation">;</span>queue<span class="token operator">-></span>res<span class="token operator">--</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> size<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> queue<span class="token operator">-></span>res<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>queue<span class="token operator">-></span>tail<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">free</span><span class="token punctuation">(</span>node<span class="token operator">-></span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> size<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">clean_queuelist</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Type buff<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_qempty</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">Pop_QueueList</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span>buff<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//销毁队列</span><span class="token keyword">int</span> <span class="token function">destroy_queuelist</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span><span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> <span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>Node<span class="token operator">*</span> head_node <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head<span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>Node<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head<span class="token punctuation">;</span>node <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Node<span class="token operator">*</span> temp <span class="token operator">=</span> node<span class="token punctuation">;</span>node <span class="token operator">=</span> node<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token operator">-></span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>res<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span><span class="token punctuation">(</span>Node<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Node<span class="token operator">*</span> temp <span class="token operator">=</span> node<span class="token punctuation">;</span>node <span class="token operator">=</span> node<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token operator">-></span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>res<span class="token operator">--</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>head_node <span class="token operator">==</span> node<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></div></div>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 队列 </tag>
            
            <tag> 环型队列 </tag>
            
            <tag> 链式队列 </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>管脚复用</title>
      <link href="/2021/07/15/guan-jiao-jie-fu-yong/"/>
      <url>/2021/07/15/guan-jiao-jie-fu-yong/</url>
      
        <content type="html"><![CDATA[<h3 id="管脚复用"><a href="#管脚复用" class="headerlink" title="管脚复用"></a>管脚复用</h3><p>管脚复用指一个引脚具有多种功能，可以在不同时刻使用不同的功能(时分复用)，需要通过配置寄存器来开关芯片外部引脚和内部引脚的连接。</p><span id="more"></span><h4 id="引脚内部情况"><a href="#引脚内部情况" class="headerlink" title="引脚内部情况"></a>引脚内部情况</h4><p><img "" class="lazyload placeholder" data-original="/photo/gpio/7.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><table>    <tr>        <td>引脚</td>         <td>寄存器值</td>        <td>引脚功能</td>   </tr>    <tr>        <td rowspan="3">PA1</td>            <td >0x00</td>         <td >GPIO</td>      </tr>    <tr>        <td >0x01</td>        <td >UART_RX</td>        </tr>        <tr>        <td >0x10</td>        <td >PWM</td>        </tr></table><h4 id="设置GPIO模式"><a href="#设置GPIO模式" class="headerlink" title="设置GPIO模式"></a>设置GPIO模式</h4><p>若要将PA1设置成GPIO模式<br>首先，需要查询手册找到PA1的寄存器地址，设地址为<font color='red'> 0x120F0218 </font><br>上表中的类似数据也可以在手册查找，GPIO功能寄存器要设置为0x00。可以直接设置该地址值为0x00。</p><p>有些芯片手册不会直接告诉该引脚的寄存器地址，会告诉你寄存器基地址，这时候要更具手册告诉的<font color='red'>基地址+偏移</font>去设置寄存器<br><img "" class="lazyload placeholder" data-original="/photo/gpio/8.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br><img "" class="lazyload placeholder" data-original="/photo/gpio/9.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>可以看到寄存器基地址为<font color='red'> 0xFE030000 </font>，上图中的引脚要设置为GPIO_0_0使用，就要设置<font color='red'> 0xFE030000 + 0x20基地址偏移后地址上的值 </font>，图中 2..0 是表示该地址下第第0位到第2位，这三位上的数据表示该引脚的复用模式。<br>但是不能直接往<font color='red'> 0xFE030020 </font>地址设置0x0,这样设置会把其他位的值全部置0.<br>因此，先读取<font color='red'> 0xFE030020 </font>地址上的值，假设读出来的值是 0x26fea113。<br>我们要设置的是前面3位设置为0，第0位到第2位占了3位，要将其置0。111B = 0x7,在第0位开始，所以左移 0 位， (0x7 &lt;&lt; 0)。取反~(0x7)即其他位都为1，低3位变0，11111…..111000B。和0x26fea113 进行&amp;运算，就仅仅只会改变低三位的值。<br>0x26fea113 = 00100110111111101010000100010011B</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">0x26fea113</span><span class="token punctuation">;</span>val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x7</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>；<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>得到 val =  0x26fea110<br>将0x26fea110写入寄存器就完成了设置该引脚复用为GPIO_0_0。</p><h4 id="设置X-I2S2-MCLK"><a href="#设置X-I2S2-MCLK" class="headerlink" title="设置X_I2S2_MCLK"></a>设置X_I2S2_MCLK</h4><p>那设置成X_I2S2_MCLK怎么设置呢？<br>设置该复用模式，需要将这寄存器上这三位设置为0x3 = 011B<br>分步来</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">0x26fea113</span><span class="token punctuation">;</span><span class="token comment">//将第三位置0，</span>val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//val = 0010 0110 1111 1110 1010 0001 0001 0011 &amp; 1111 1111 1111 1111 1111 1111 1111 1011</span><span class="token comment">//将第一位第二位置1</span>val <span class="token operator">|=</span> <span class="token number">0x3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//val = 00100110111111101010000100010011 | 0x11</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此时得到的val = 0x26fea113;<br>将0x26fea113写入寄存器就完成了设置该引脚复用为X_I2S2_MCLK。</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> Gpio </tag>
            
            <tag> 管脚复用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux用户态设置gpio</title>
      <link href="/2021/07/12/linux-yong-hu-tai-she-zhi-gpio/"/>
      <url>/2021/07/12/linux-yong-hu-tai-she-zhi-gpio/</url>
      
        <content type="html"><![CDATA[<h2 id="Linux用户态设置GPIO"><a href="#Linux用户态设置GPIO" class="headerlink" title="Linux用户态设置GPIO"></a>Linux用户态设置GPIO</h2><p>当单独排查或调试某个引脚相关硬件时，如果直接运行app程序，通过代码修改一次运行一次会比较麻烦。<br>这个时候应当单独对该引脚调试，也可避免程序中可能存在未知的地方修改引脚。</p><span id="more"></span><h3 id="一、GPIO操作相关目录以及接口"><a href="#一、GPIO操作相关目录以及接口" class="headerlink" title="一、GPIO操作相关目录以及接口"></a>一、GPIO操作相关目录以及接口</h3><h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><p>/sys/class/gpio/</p><h4 id="export"><a href="#export" class="headerlink" title="export"></a>export</h4><p>用于导出指定编号的引脚，用为GPIO直接使用</p><h4 id="unexport"><a href="#unexport" class="headerlink" title="unexport"></a>unexport</h4><p>删除导出的GPIO</p><h3 id="二、GPIO使用"><a href="#二、GPIO使用" class="headerlink" title="二、GPIO使用"></a>二、GPIO使用</h3><h4 id="进入-sys-class-gpio-目录"><a href="#进入-sys-class-gpio-目录" class="headerlink" title="进入/sys/class/gpio/目录"></a>进入/sys/class/gpio/目录</h4><p>终端输入:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /sys/class/gpio/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/gpio/1.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><h4 id="添加GPIO"><a href="#添加GPIO" class="headerlink" title="添加GPIO"></a>添加GPIO</h4><p>终端输入: </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">30</span> <span class="token operator">></span> <span class="token builtin class-name">export</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/gpio/2.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><p>可以发现目录下出现了一个gpio30，这就代表添加gpio成功了。如果执行后没有添加上，没反应或提示不能添加，表示该gpio已经被作为其他功能使用。</p><h4 id="操作GPIO"><a href="#操作GPIO" class="headerlink" title="操作GPIO"></a>操作GPIO</h4><p>终端输入:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> gpio30<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/gpio/3.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><p>使用ls命令可以查看到进去后目录下的几个文件如上图。</p><h5 id="direction"><a href="#direction" class="headerlink" title="direction"></a>direction</h5><p>设置引脚输出输入方向<br>1、设置输入</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token keyword">in</span> <span class="token operator">></span> direction<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/gpio/4.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>检查是否设置成功</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> direction<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/gpio/5.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>显示为in，则设置输入方向成功</p><p>2、设置输出</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> out <span class="token operator">></span> direction<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>检查是否成功同上</p><h5 id="value"><a href="#value" class="headerlink" title="value"></a>value</h5><p>1、设置高电平</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><font color='red'> 注意 </font> :该设置操作必须要上面输出输入设置为输出才能设置</p><p><img "" class="lazyload placeholder" data-original="/photo/gpio/6.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>如图，查询得知原来为低电平，value为0，设置后查询得知为1.设置成功。</p><p>2、设置低电平</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">0</span> <span class="token operator">></span> value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="note info"><p>当上述操作后如果，设置高电平应当是3.3V，测量电压却远低于3.3V，这个时候就需要直接操作寄存器来查看管脚复用情况，确认是否正确解复用为gpio模式</p></div><p>👇👇👇👇👇<br><a href="https://marysufer.com/2021/07/15/guan-jiao-jie-fu-yong">管脚复用</a><br><a href="">命令读写寄存器</a></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 嵌入式 </tag>
            
            <tag> Gpio </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
