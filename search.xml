<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>busybox编译以及添加menuconfig配置选项</title>
      <link href="/2023/09/26/busybox-tian-jia-menuconfig-pei-zhi-xuan-xiang/"/>
      <url>/2023/09/26/busybox-tian-jia-menuconfig-pei-zhi-xuan-xiang/</url>
      
        <content type="html"><![CDATA[<h4 id="一、busybox介绍"><a href="#一、busybox介绍" class="headerlink" title="一、busybox介绍"></a>一、busybox介绍</h4><p>Busybox是一个开源项目，遵循GPL v2协议。Busybox将众多的UNIX命令集合进了一个很小的可执行程序中，可以用来替代GNU fileutils、shellutils等工具集。Busybox中各种命令与相应的GNU工具相比，所能提供的选项比较少，但是对于一般的应用场景也足够了。Busybox主要用于嵌入式系统的开发中。</p><h4 id="二、busybox目录结构"><a href="#二、busybox目录结构" class="headerlink" title="二、busybox目录结构"></a>二、busybox目录结构</h4><table>    <tr>        <td>序号</td>         <td>目录名称</td>        <td>功能说明</td>   </tr>    <tr>        <td > 1 </td>            <td >applets</td>         <td >实现applets框架的文件。目录中包含了几个main()的文件</td>      </tr>    <tr>        <td >2</td>        <td >applets_sh</td>            <td >此目录包含了几个作为shell脚本实现的applet示例。在“make install”时不会被自动安装，需要使用时，手动处理</td>      </tr>    <tr>        <td >3</td>        <td >arch</td>           <td >包含用于不同体系架构的makefile文件。约束busybox在不同架构体系下的编译构建过程</td>       </tr>    <tr>        <td >4</td>        <td >archival</td>           <td >与压缩相关命令的实现源文件</td>       </tr>    <tr>        <td >5</td>        <td >configs</td>           <td >busybox自带的默认配置文件</td>       </tr>    <tr>        <td >6</td>        <td >console-tools</td>           <td >与控制台相关的一些命令</td>       </tr>    <tr>        <td >7</td>        <td >coreutils</td>           <td >常用的一些核心命令。例如chgrp、rm等</td>       </tr>    <tr>        <td >8</td>        <td >debianutils</td>           <td >针对Debian的套件。</td>       </tr>    <tr>        <td >9</td>        <td >e2fsprogs</td>           <td >针对Linux Ext2 FS prog的命令。例如chattr、lsattr</td>       </tr>    <tr>        <td >10</td>        <td >editors</td>           <td >常用的编辑命令。例如diff、vi等</td>       </tr>    <tr>        <td >11</td>        <td >findutils</td>           <td >用于查找的命令</td>       </tr>    <tr>        <td >12</td>        <td >include</td>           <td >busybox项目的头文件</td>       </tr>    <tr>        <td >13</td>        <td >init</td>           <td >init进程的实现源码目录</td>       </tr>    <tr>        <td >14</td>        <td >klibc-utils</td>           <td >klibc命令套件</td>       </tr>    <tr>        <td >15</td>        <td >libbb</td>           <td >与busybox实现相关的库文件</td>       </tr>    <tr>        <td >16</td>        <td >libpwdgrp</td>           <td >libpwdgrp相关的命令</td>       </tr>    <tr>        <td >17</td>        <td >loginutils</td>           <td >与用户管理相关的命令</td>       </tr>    <tr>        <td >18</td>        <td >mailutils</td>           <td >与mail相关的命令套件</td>       </tr>    <tr>        <td >19</td>        <td >miscutils</td>           <td >该文件下是一些杂项命令，针对特定应用场景</td>       </tr>    <tr>        <td >20</td>        <td >modutils</td>           <td >与模块相关的命令</td>       </tr>    <tr>        <td >21</td>        <td >networking</td>           <td >与网络相关的命令，例如arp</td>       </tr>    <tr>        <td >22</td>        <td >printutils</td>           <td >Print相关的命令</td>       </tr>    <tr>        <td >23</td>        <td >procps</td>           <td >与内存、进程相关的命令</td>       </tr>    <tr>        <td >24</td>        <td >runit</td>           <td >与Runit实现相关的命令</td>       </tr>    <tr>        <td >25</td>        <td >shell</td>           <td >与shell相关的命令</td>       </tr>    <tr>        <td >26</td>        <td >sysklogd</td>           <td >系统日志记录工具相关的命令</td>       </tr>    <tr>        <td >27</td>        <td >util-linux</td>           <td >Linux下常用的命令，主要与文件系统操作相关的命令</td>       </tr></table><h4 id="三、编译busybox-（BusyBox-1-33-1）"><a href="#三、编译busybox-（BusyBox-1-33-1）" class="headerlink" title="三、编译busybox （BusyBox-1.33.1）"></a>三、编译busybox （BusyBox-1.33.1）</h4><h5 id="1、make-menuconfig"><a href="#1、make-menuconfig" class="headerlink" title="1、make menuconfig"></a>1、make menuconfig</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> menuconfig<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/busybox/make_menuconfig.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="make menuconfig界面"></p><p>配置install路径，首先选择Settings—&gt;<br><img "" class="lazyload placeholder" data-original="/photo/busybox/menuconfig_Settings.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="Settings---&gt;"><br>然后选择Installation Options中的Destination path for ‘make install’选项配置install目录。<br><img "" class="lazyload placeholder" data-original="/photo/busybox/menuconfig_Install_opt.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="Installation Options"><br>我们将其设置为romfs<br><img "" class="lazyload placeholder" data-original="/photo/busybox/menuconfig_Install_opt_setting.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="set ./romfs"><br>保存config后可以再目录中看到一个.config文件</p><h5 id="3、编译和建立romfs目录"><a href="#3、编译和建立romfs目录" class="headerlink" title="3、编译和建立romfs目录"></a>3、编译和建立romfs目录</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#建立romfs目录</span><span class="token function">mkdir</span> romfs<span class="token builtin class-name">cd</span> rootfs<span class="token comment">#建立一些常用目录</span><span class="token function">mkdir</span> root home bin sbin etc dev usr lib tmp mnt sys proc  <span class="token function">mkdir</span> usr/lib usr/bin<span class="token comment">#配置交叉编译器，修改Makefile文件</span>ARCH ?<span class="token operator">=</span> armCROSS_COMPILE ?<span class="token operator">=</span> <span class="token comment">#指定交叉编译器路径</span><span class="token comment">#编译</span><span class="token comment">#make 后就会产生busybox</span><span class="token function">make</span><span class="token comment">#make install后就产生busybox及每个命令的软链接。</span><span class="token function">make</span> <span class="token function">install</span><span class="token builtin class-name">cd</span> etc<span class="token comment">#拷贝examples/bootfloppy/etc文件到etc</span><span class="token function">cp</span> -rf <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/examples/bootfloppy/etc/* ./<span class="token comment">#passwd、shadow、group等文件也需要准备放到etc下</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>拷贝examples/inittab 到 etc下,做一些必要的修改</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># /etc/inittab init(8) configuration for BusyBox</span><span class="token comment">#</span><span class="token comment"># Copyright (C) 1999-2004 by Erik Andersen &lt;andersen@codepoet.org></span><span class="token comment">#</span><span class="token comment">#</span><span class="token comment"># Note, BusyBox init doesn't support runlevels.  The runlevels field is</span><span class="token comment"># completely ignored by BusyBox init. If you want runlevels, use sysvinit.</span><span class="token comment">#</span><span class="token comment">#</span><span class="token comment"># Format for each entry: &lt;id>:&lt;runlevels>:&lt;action>:&lt;process></span><span class="token comment">#</span><span class="token comment"># &lt;id>: WARNING: This field has a non-traditional meaning for BusyBox init!</span><span class="token comment">#</span><span class="token comment">#The id field is used by BusyBox init to specify the controlling tty for</span><span class="token comment">#the specified process to run on.  The contents of this field are</span><span class="token comment">#appended to "/dev/" and used as-is.  There is no need for this field to</span><span class="token comment">#be unique, although if it isn't you may have strange results.  If this</span><span class="token comment">#field is left blank, then the init's stdin/out will be used.</span><span class="token comment">#</span><span class="token comment"># &lt;runlevels>: The runlevels field is completely ignored.</span><span class="token comment">#</span><span class="token comment"># &lt;action>: Valid actions include: sysinit, wait, once, respawn, askfirst,</span><span class="token comment">#                                  shutdown, restart and ctrlaltdel.</span><span class="token comment">#</span><span class="token comment">#sysinit actions are started first, and init waits for them to complete.</span><span class="token comment">#wait actions are started next, and init waits for them to complete.</span><span class="token comment">#once actions are started next (and not waited for).</span><span class="token comment">#</span><span class="token comment">#askfirst and respawn are started next.</span><span class="token comment">#For askfirst, before running the specified process, init displays</span><span class="token comment">#the line "Please press Enter to activate this console"</span><span class="token comment">#and then waits for the user to press enter before starting it.</span><span class="token comment">#</span><span class="token comment">#shutdown actions are run on halt/reboot/poweroff, or on SIGQUIT.</span><span class="token comment">#Then the machine is halted/rebooted/powered off, or for SIGQUIT,</span><span class="token comment">#restart action is exec'ed (init process is replaced by that process).</span><span class="token comment">#If no restart action specified, SIGQUIT has no effect.</span><span class="token comment">#</span><span class="token comment">#ctrlaltdel actions are run when SIGINT is received</span><span class="token comment">#(this might be initiated by Ctrl-Alt-Del key combination).</span><span class="token comment">#After they complete, normal processing of askfirst / respawn resumes.</span><span class="token comment">#</span><span class="token comment">#Note: unrecognized actions (like initdefault) will cause init to emit</span><span class="token comment">#an error message, and then go along with its business.</span><span class="token comment">#</span><span class="token comment"># &lt;process>: Specifies the process to be executed and it's command line.</span><span class="token comment">#</span><span class="token comment"># Note: BusyBox init works just fine without an inittab. If no inittab is</span><span class="token comment"># found, it has the following default behavior:</span><span class="token comment">#::sysinit:/etc/init.d/rcS</span><span class="token comment">#::askfirst:/bin/sh</span><span class="token comment">#::ctrlaltdel:/sbin/reboot</span><span class="token comment">#::shutdown:/sbin/swapoff -a</span><span class="token comment">#::shutdown:/bin/umount -a -r</span><span class="token comment">#::restart:/sbin/init</span><span class="token comment">#tty2::askfirst:/bin/sh</span><span class="token comment">#tty3::askfirst:/bin/sh</span><span class="token comment">#tty4::askfirst:/bin/sh</span><span class="token comment">#</span><span class="token comment"># Boot-time system configuration/initialization script.</span><span class="token comment"># This is run first except when booting in single-user mode.</span><span class="token comment">#</span>::sysinit:/etc/init.d/rcS<span class="token comment"># /bin/sh invocations on selected ttys</span><span class="token comment">#</span><span class="token comment"># Note below that we prefix the shell commands with a "-" to indicate to the</span><span class="token comment"># shell that it is supposed to be a login shell.  Normally this is handled by</span><span class="token comment"># login, but since we are bypassing login in this case, BusyBox lets you do</span><span class="token comment"># this yourself...</span><span class="token comment">#</span><span class="token comment"># Start an "askfirst" shell on the console (whatever that may be)</span><span class="token comment">#askfirst类似respawn，主要用途是减少系统上执行的终端应用程序的数量。它将会促使init在控制台上显示“Please press Enter to active this console”的信息，并在重新启动进程之前等待用户按下“enter”键</span><span class="token comment">#::askfirst:-/bin/sh</span><span class="token comment"># Start an "askfirst" shell on /dev/tty2-4</span><span class="token comment">#</span><span class="token comment">#tty2::askfirst:-/bin/sh</span><span class="token comment">#tty3::askfirst:-/bin/sh</span><span class="token comment">#tty4::askfirst:-/bin/sh</span><span class="token comment"># /sbin/getty invocations for selected ttys</span><span class="token comment">#屏蔽</span><span class="token comment">#tty4::respawn:/sbin/getty 38400 tty5</span><span class="token comment">#tty5::respawn:/sbin/getty 38400 tty6</span><span class="token comment"># Example of how to put a getty on a serial line (for a terminal)</span>::respawn:/sbin/getty -L ttyS000 <span class="token number">115200</span> vt100 -n root -I <span class="token string">"Auto login as root ..."</span><span class="token comment">#::respawn:/sbin/getty -L ttyS0 9600 vt100</span><span class="token comment">#::respawn:/sbin/getty -L ttyS1 9600 vt100</span><span class="token comment">#</span><span class="token comment"># Example how to put a getty on a modem line.</span><span class="token comment">#::respawn:/sbin/getty 57600 ttyS2</span><span class="token comment"># Stuff to do when restarting the init process</span>::restart:/sbin/init<span class="token comment"># Stuff to do before rebooting</span>::ctrlaltdel:/sbin/reboot::shutdown:/bin/umount -a -r::shutdown:/sbin/swapoff -a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>拷贝交叉编译环境下的lib库到romfs/lib目录下</p><h4 id="四、busybox的menuconfig添加自定义编译选项"><a href="#四、busybox的menuconfig添加自定义编译选项" class="headerlink" title="四、busybox的menuconfig添加自定义编译选项"></a>四、busybox的menuconfig添加自定义编译选项</h4><p>以telnetd端口和udhcpd mac限制和hostname限制为例</p><h5 id="1、Config-src-和-Config-in"><a href="#1、Config-src-和-Config-in" class="headerlink" title="1、Config.src 和 Config.in"></a>1、Config.src 和 Config.in</h5><p>Config.src文件中保存着make menuconfig配置界面上的配置<br>Config.in是通过Config.src和.c源码中的一些config配置结合产生的。<br>下面以networking/Config.src为例大致说明配置的含义</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#</span><span class="token comment"># For a description of the syntax of this configuration file,</span><span class="token comment"># see docs/Kconfig-language.txt.</span><span class="token comment">#</span><span class="token comment">#菜单选项</span>menu <span class="token string">"Networking Utilities"</span> config FEATURE_IPV6bool <span class="token string">"Enable IPv6 support"</span>default y<span class="token builtin class-name">help</span>Enable IPv6 support <span class="token keyword">in</span> busybox.This adds IPv6 support <span class="token keyword">in</span> the networking applets.config FEATURE_UNIX_LOCALbool <span class="token string">"Enable Unix domain socket support (usually not needed)"</span>default n<span class="token builtin class-name">help</span>Enable Unix domain socket support <span class="token keyword">in</span> all busybox networkingapplets.  Address of the form local:/path/to/unix/socketwill be recognized.This extension is almost never used <span class="token keyword">in</span> real world usage.You <span class="token function">most</span> likely want to say N.config FEATURE_PREFER_IPV4_ADDRESSbool <span class="token string">"Prefer IPv4 addresses from DNS queries"</span>default ydepends on FEATURE_IPV6<span class="token builtin class-name">help</span>Use IPv4 address of network <span class="token function">host</span> <span class="token keyword">if</span> it has one.If this option is off, the first returned address will be used.This may cause problems when your DNS server is IPv6-capable andis returning IPv6 <span class="token function">host</span> addresses too. If IPv6 addressprecedes IPv4 one <span class="token keyword">in</span> DNS reply, busybox network applets<span class="token punctuation">(</span>e.g. <span class="token function">wget</span><span class="token punctuation">)</span> will use IPv6 address. On an IPv6-incapable <span class="token function">host</span>or network applets will fail to connect to the <span class="token function">host</span>using IPv6 address.config VERBOSE_RESOLUTION_ERRORSbool <span class="token string">"Verbose resolution errors"</span>default n<span class="token builtin class-name">help</span>Enable <span class="token keyword">if</span> you are not satisfied with simplistic<span class="token string">"can't resolve 'hostname.com'"</span> and want to know more.This may increase size of your executable a bit.config FEATURE_TLS_SHA1 <span class="token comment">#config配置名</span>bool <span class="token string">"In TLS code, support ciphers which use deprecated SHA1"</span> <span class="token comment">#数据类型是bool型所以参数是 y和n</span>depends on TLS  <span class="token comment">#依赖TLS开启该配置才可以生效配置。</span>default n       <span class="token comment">#默认配置为n,不开启</span><span class="token builtin class-name">help</span>   <span class="token comment">#help介绍该配置</span>Selecting this option increases interoperability with very oldservers, but slightly increases code size.Most TLS servers support SHA256 today <span class="token punctuation">(</span><span class="token number">2018</span><span class="token punctuation">)</span>, since SHA1 isconsidered possibly insecure <span class="token punctuation">(</span>although not yet definitely broken<span class="token punctuation">)</span>.<span class="token comment">#INSERT</span><span class="token comment">#source networking/udhcp/Config.in</span><span class="token comment">#是将里面一级的目录中的配置插入进本文件，所有配置都是如此一层一层目录中插入过来。也能将c源文件中注释语句中的config插入</span>INSERT<span class="token builtin class-name">source</span> networking/udhcp/Config.inconfig IFUPDOWN_UDHCPC_CMD_OPTIONSstring <span class="token string">"ifup udhcpc command line options"</span>default <span class="token string">"-R -n"</span>depends on IFUP <span class="token operator">||</span> IFDOWN<span class="token builtin class-name">help</span>Command line options to pass to udhcpc from ifup.Intended to alter options not available <span class="token keyword">in</span> /etc/network/interfaces.<span class="token punctuation">(</span>IE: --syslog --background etc<span class="token punctuation">..</span>.<span class="token punctuation">)</span>endmenu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="2、Kbuild-src和Kbuild"><a href="#2、Kbuild-src和Kbuild" class="headerlink" title="2、Kbuild.src和Kbuild"></a>2、Kbuild.src和Kbuild</h5><p>Kbuild.src是更具配置决定某个源文件是否要编译的配置文件，比如添加新的源文件要通过配置来控制就需要再这边添加<br>Kbuild是由Kbuild.src和递归当前源文件下的配置而成<br>以networking/udhcp/Kbuild.src为例</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Makefile for busybox</span><span class="token comment">#</span><span class="token comment"># Copyright (C) 1999-2004 by Erik Andersen &lt;andersen@codepoet.org></span><span class="token comment">#</span><span class="token comment"># Licensed under GPLv2 or later, see file LICENSE in this source tree.</span><span class="token comment">#</span>lib-y:<span class="token operator">=</span><span class="token comment">#INSERT 可以插入.C源文件中注释中的Kbuild配置生成Kbuild，一层一层的生成后，递归后就得到所有要编译进去的文件</span>INSERT<span class="token comment">#$(CONFIG_UDHCPC)就是再makeconfig所配置的，为y或者n</span>lib-<span class="token variable"><span class="token variable">$(</span>CONFIG_UDHCPC<span class="token variable">)</span></span>     <span class="token operator">+=</span> common.o packet.o signalpipe.o socket.olib-<span class="token variable"><span class="token variable">$(</span>CONFIG_UDHCPD<span class="token variable">)</span></span>     <span class="token operator">+=</span> common.o packet.o signalpipe.o socket.olib-<span class="token variable"><span class="token variable">$(</span>CONFIG_UDHCPC<span class="token variable">)</span></span>     <span class="token operator">+=</span> dhcpc.olib-<span class="token variable"><span class="token variable">$(</span>CONFIG_UDHCPD<span class="token variable">)</span></span>     <span class="token operator">+=</span> dhcpd.o arpping.olib-<span class="token variable"><span class="token variable">$(</span>CONFIG_DUMPLEASES<span class="token variable">)</span></span> <span class="token operator">+=</span> dumpleases.olib-<span class="token variable"><span class="token variable">$(</span>CONFIG_DHCPRELAY<span class="token variable">)</span></span>  <span class="token operator">+=</span> dhcprelay.o common.o socket.o packet.olib-<span class="token variable"><span class="token variable">$(</span>CONFIG_FEATURE_UDHCPC_ARPING<span class="token variable">)</span></span> <span class="token operator">+=</span> arpping.olib-<span class="token variable"><span class="token variable">$(</span>CONFIG_FEATURE_UDHCP_RFC3397<span class="token variable">)</span></span> <span class="token operator">+=</span> domain_codec.o<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="3、添加telnetd-端口自定义配置"><a href="#3、添加telnetd-端口自定义配置" class="headerlink" title="3、添加telnetd 端口自定义配置"></a>3、添加telnetd 端口自定义配置</h5><p>打开telnetd相关源文件，再其源文件中添加配置修改代码</p><p>telnetd.c</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//config:config IS_NOLANCHECK</span><span class="token comment">//config:bool "Support not check lan"</span><span class="token comment">//config:default n</span><span class="token comment">//config:depends on TELNETD</span><span class="token comment">//config:help</span><span class="token comment">//config:Support check lan.</span><span class="token comment">//config:</span><span class="token comment">//config:config TELNETD_PORT</span><span class="token comment">//config:int "Support set telnetd port"</span><span class="token comment">//config:default 25565</span><span class="token comment">//config:range 0 65535</span><span class="token comment">//config:depends on TELNETD</span><span class="token comment">//config:help</span><span class="token comment">//config:set telnetd port.</span><span class="token comment">//config:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/busybox/telnetdConfig.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="telnetdConfig"><br><img "" class="lazyload placeholder" data-original="/photo/busybox/telnetdPort.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="telnetdPort"><br>CONFIG_TELNETD_PORT宏定义在include/autoconf.h头文件中是由make menuconfig生成的头文件<br>添加IS_NOLANCHECK和TELNETD_PORT两个配置。<br>IS_NOLANCHECK的数据类型是bool所以是y和n，TELNETD_PORT数据类型是int所以是数字。<br>default字段配置该选项的默认配置，端口默认配置为50119做了修改和常规的端口不同，range 0 65535语句限制端口设置的范围再0到65535之间。两个配置都有depends on TELNETD，依赖该前置配置，只有TELNETD配置开启后才能生效。源码中把写死的端口修改为CONFIG_TELNETD_PORT。就实现了再menuconfig配置端口。<br>如下图，可以看到配置表中已经多了端口配置选项。<br><img "" class="lazyload placeholder" data-original="/photo/busybox/menuconfig_telnetdPort.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="menuconfig_telnetdPort"></p><h5 id="4、dhcpd添加自定义hostname限制和自定义mac地址限制"><a href="#4、dhcpd添加自定义hostname限制和自定义mac地址限制" class="headerlink" title="4、dhcpd添加自定义hostname限制和自定义mac地址限制"></a>4、dhcpd添加自定义hostname限制和自定义mac地址限制</h5><p>networking/udhcp/Config.src文件中添加相关menuconfig配置选项如下<br>Config.src</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#</span><span class="token comment"># For a description of the syntax of this configuration file,</span><span class="token comment"># see docs/Kconfig-language.txt.</span><span class="token comment">#</span>config UDHCPDbool <span class="token string">"udhcpd (21 kb)"</span>default y<span class="token builtin class-name">help</span>udhcpd is a DHCP server geared primarily toward embedded systems,<span class="token keyword">while</span> striving to be fully functional and RFC compliant.<span class="token comment">#######################添加开始###############################</span><span class="token comment">#是否开启honstname设置功能</span>config UDHCPD_SET_HOSTNAMEbool <span class="token string">"udhcpd set hostname restrictions"</span>default ndepends on UDHCPD<span class="token builtin class-name">help</span>udhcpd <span class="token builtin class-name">set</span> <span class="token function">hostname</span> restrictions.<span class="token comment">#honstname设置选项，数据类型为string，默认为空字符串即不限制</span>config UDHCPD_HOSTNAMEstring <span class="token string">"udhcpd set hostname restrictions"</span>default <span class="token string">""</span>depends on UDHCPD_SET_HOSTNAME<span class="token builtin class-name">help</span>A <span class="token function">hostname</span> is <span class="token string">"A"</span>B <span class="token function">hostname</span> is <span class="token string">"B"</span><span class="token comment">#是否开启mac限制功能</span>config UDHCPD_SET_HOSTMACbool <span class="token string">"udhcpd set  mac restrictions"</span>default ndepends on UDHCPD<span class="token builtin class-name">help</span>udhcpd <span class="token builtin class-name">set</span>  mac restrictions.<span class="token comment">#配置mac限制，再对应mac字段配置mac即可限制该字段。可以实现自定义任意位mac限制</span>config UDHCPD_HOSTMACstring <span class="token string">"udhcpd set hostmac restrictions"</span>default <span class="token string">"51:1B:17:::"</span>depends on UDHCPD_SET_HOSTMAC<span class="token builtin class-name">help</span>Example  Restrict MAC <span class="token number">51</span>:1B:17:::Restrict the first <span class="token number">3</span> MAC addresses is 0x51 0x1B 0x17,can allocate IP.Example  Restrict MAC ::::2B:Restrict the fifth MAC addresses is 0x2B,can allocate IP.<span class="token comment">################################添加结束#############################</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下图是udhcpd相关menuconfig添加后的选项，选上udhpcd选项后就会出现udhcpd set hostname restrictions和udhcpd set  mac restrictions选项，将这两个选项选中后即可自定义hostname限制和mac限制。<br><img "" class="lazyload placeholder" data-original="/photo/busybox/menuconfig_udhcpd.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="menuconfig_udhcpd"></p><p>udhcpd.c源码有修改的函数如下</p><pre class="line-numbers language-C" data-language="C"><code class="language-C">static NOINLINE void send_offer(struct dhcp_packet *oldpacket,uint32_t static_lease_nip,struct dyn_lease *lease,uint32_t requested_nip,unsigned arpping_ms)&#123;struct dhcp_packet packet;uint32_t lease_time_sec;init_packet(&amp;packet, oldpacket, DHCPOFFER);&#x2F;* If it is a static lease, use its IP *&#x2F;packet.yiaddr &#x3D; static_lease_nip;&#x2F;* Else: *&#x2F;if (!static_lease_nip) &#123;&#x2F;* We have no static lease for client&#39;s chaddr *&#x2F;const char *p_host_name;if (lease) &#123;&#x2F;* We have a dynamic lease for client&#39;s chaddr. * Reuse its IP (even if lease is expired). * Note that we ignore requested IP in this case. *&#x2F;packet.yiaddr &#x3D; lease-&gt;lease_nip;&#125;&#x2F;* Or: if client has requested an IP *&#x2F;else if (requested_nip !&#x3D; 0 &#x2F;* and the IP is in the lease range *&#x2F; &amp;&amp; ntohl(requested_nip) &gt;&#x3D; server_data.start_ip &amp;&amp; ntohl(requested_nip) &lt;&#x3D; server_data.end_ip &#x2F;* and *&#x2F; &amp;&amp; (  !(lease &#x3D; find_lease_by_nip(requested_nip)) &#x2F;* is not already taken *&#x2F;    || is_expired_lease(lease) &#x2F;* or is taken, but expired *&#x2F;    )) &#123;packet.yiaddr &#x3D; requested_nip;&#125;else &#123;&#x2F;* Otherwise, find a free IP *&#x2F;packet.yiaddr &#x3D; find_free_or_expired_nip(oldpacket-&gt;chaddr, arpping_ms);&#125;if (!packet.yiaddr) &#123;bb_simple_error_msg(&quot;no free IP addresses. OFFER abandoned&quot;);return;&#125;&#x2F;* Reserve the IP for a short time hoping to get DHCPREQUEST soon *&#x2F;p_host_name &#x3D; (const char*) udhcp_get_option(oldpacket, DHCP_HOST_NAME);&#x2F;*********hostname限制 *********&#x2F;&#x2F;*ENABLE_UDHCPD_SET_HOSTNAME宏定义在include&#x2F;autoconf.h头文件中，该头文件是make menuconfig配置选项保存后生成的*&#x2F;#if ENABLE_UDHCPD_SET_HOSTNAME if(p_host_name !&#x3D; NULL &amp;&amp; strstr(p_host_name, CONFIG_UDHCPD_HOSTNAME))&#123;lease &#x3D; add_lease(packet.chaddr, packet.yiaddr,server_data.offer_time,p_host_name,p_host_name ? (unsigned char)p_host_name[OPT_LEN - OPT_DATA] : 0);&#125;else&#123;bb_info_msg(&quot;Not Found --&gt; %s\n&quot;,CONFIG_UDHCPD_HOSTNAME);return;&#125;#elselease &#x3D; add_lease(packet.chaddr, packet.yiaddr,server_data.offer_time,p_host_name,p_host_name ? (unsigned char)p_host_name[OPT_LEN - OPT_DATA] : 0);#endif&#x2F;********* hostname限制 *********&#x2F;if (!lease) &#123;bb_simple_error_msg(&quot;no free IP addresses. OFFER abandoned&quot;);return;&#125;&#125;lease_time_sec &#x3D; select_lease_time(oldpacket);udhcp_add_simple_option(&amp;packet, DHCP_LEASE_TIME, htonl(lease_time_sec));add_server_options(&amp;packet);&#x2F;* send_packet emits error message itself if it detects failure *&#x2F;send_packet_verbose(&amp;packet, &quot;sending OFFER to %s&quot;);&#125;&#x2F;********* MAC限制 *********&#x2F;&#x2F;*这两个函数主要功能是解析配置下来的mac限制CONFIG_UDHCPD_HOSTMAC和ENABLE_UDHCPD_SET_HOSTMAC宏定义在include&#x2F;autoconf.h头文件中，该头文件make menuconfig配置后生成的头文件*&#x2F;#if ENABLE_UDHCPD_SET_HOSTMACstatic int strToChar(char *pStr, int j, unsigned char *pMacCh)&#123;int i;if(j &gt; 2) return -1;  &#x2F;&#x2F;mac errfor(i &#x3D; j;i &gt; 0;i-- )&#123;if( pStr[i - 1] &gt;&#x3D; &#39;a&#39; &amp;&amp; pStr[i - 1] &lt;&#x3D; &#39;f&#39;)&#123;*pMacCh +&#x3D; (pStr[i - 1] - &#39;a&#39; + 0xa) * (0x1 &lt;&lt; 4*(j-i));&#125;else if( pStr[i - 1] &gt;&#x3D; &#39;A&#39; &amp;&amp; pStr[i - 1] &lt;&#x3D; &#39;F&#39;)&#123;*pMacCh +&#x3D; (pStr[i - 1] - &#39;A&#39; + 0xa) * (0x1 &lt;&lt; 4*(j-i));&#125;else if( pStr[i - 1] &gt;&#x3D; &#39;0&#39; &amp;&amp; pStr[i - 1] &lt;&#x3D; &#39;9&#39;)&#123;*pMacCh +&#x3D; (pStr[i - 1] - &#39;0&#39;) * (0x1 &lt;&lt; 4*(j-i));&#125;&#125;return 0;&#125;static int parseHostMac(unsigned char *pMac, int *pMask)&#123;char arrStr[4] &#x3D; &#123;&#125;;char *pPreMac &#x3D; CONFIG_UDHCPD_HOSTMAC;int strLen &#x3D; strlen(CONFIG_UDHCPD_HOSTMAC);char *pTemp;char *pTempMac &#x3D; pPreMac;int i,j;*pMask &#x3D; 0;for(i &#x3D; 0; i &lt; 5; i++)&#123;pTemp &#x3D; strstr(pTempMac, &quot;:&quot;);if(NULL &#x3D;&#x3D; pTemp)&#123;return -1;&#125;if(pTemp - pTempMac &gt; 2) return -1;j &#x3D; 0;memset(arrStr,0,4);while(pTemp - pTempMac )&#123;arrStr[j] &#x3D; pTempMac[0];pTempMac +&#x3D; 1;j++;&#125;pTempMac +&#x3D; 1;if(j)&#123;if(strToChar(arrStr, j, &amp;pMac[i])) return -1;*pMask |&#x3D; 0x1 &lt;&lt; i;&#125;if(i &#x3D;&#x3D; 4)&#123;j &#x3D; 0;memset(arrStr,0,4);while(pTempMac - pPreMac &lt; strLen)&#123;arrStr[j] &#x3D; pTempMac[0];pTempMac +&#x3D; 1;j++;&#125;if(j)&#123;if(strToChar(arrStr, j, &amp;pMac[i+1])) return -1;*pMask |&#x3D; 0x1 &lt;&lt; (i + 1);&#125;&#125;&#125;return 0;&#125;#endif&#x2F;********* MAC限制*********&#x2F;int udhcpd_main(int argc UNUSED_PARAM, char **argv)&#123;int server_socket &#x3D; -1, retval;uint8_t *state;unsigned timeout_end;unsigned num_ips;unsigned opt;struct option_set *option;char *str_I &#x3D; str_I;const char *str_a &#x3D; &quot;2000&quot;;unsigned arpping_ms;IF_FEATURE_UDHCP_PORT(char *str_P;)setup_common_bufsiz();IF_FEATURE_UDHCP_PORT(SERVER_PORT &#x3D; 67;)IF_FEATURE_UDHCP_PORT(CLIENT_PORT &#x3D; 68;)&#x2F;* Make sure fd 0,1,2 are open *&#x2F;&#x2F;* Setup the signal pipe on fds 3,4 - must be before openlog() *&#x2F;udhcp_sp_setup();opt &#x3D; getopt32(argv, &quot;^&quot;&quot;fSI:va:&quot;IF_FEATURE_UDHCP_PORT(&quot;P:&quot;)&quot;\0&quot;#if defined CONFIG_UDHCP_DEBUG &amp;&amp; CONFIG_UDHCP_DEBUG &gt;&#x3D; 1&quot;vv&quot;#endif, &amp;str_I, &amp;str_aIF_FEATURE_UDHCP_PORT(, &amp;str_P)IF_UDHCP_VERBOSE(, &amp;dhcp_verbose));if (!(opt &amp; 1)) &#123; &#x2F;* no -f *&#x2F;bb_daemonize_or_rexec(0, argv);logmode &#x3D; LOGMODE_NONE;&#125;&#x2F;* update argv after the possible vfork+exec in daemonize *&#x2F;argv +&#x3D; optind;if (opt &amp; 2) &#123; &#x2F;* -S *&#x2F;openlog(applet_name, LOG_PID, LOG_DAEMON);logmode |&#x3D; LOGMODE_SYSLOG;&#125;if (opt &amp; 4) &#123; &#x2F;* -I *&#x2F;len_and_sockaddr *lsa &#x3D; xhost_and_af2sockaddr(str_I, 0, AF_INET);server_data.server_nip &#x3D; lsa-&gt;u.sin.sin_addr.s_addr;free(lsa);&#125;#if ENABLE_FEATURE_UDHCP_PORTif (opt &amp; 32) &#123; &#x2F;* -P *&#x2F;SERVER_PORT &#x3D; xatou16(str_P);CLIENT_PORT &#x3D; SERVER_PORT + 1;&#125;#endifarpping_ms &#x3D; xatou(str_a);&#x2F;* Would rather not do read_config before daemonization - * otherwise NOMMU machines will parse config twice *&#x2F;read_config(argv[0] ? argv[0] : DHCPD_CONF_FILE);&#x2F;* prevent poll timeout overflow *&#x2F;if (server_data.auto_time &gt; INT_MAX &#x2F; 1000)server_data.auto_time &#x3D; INT_MAX &#x2F; 1000;&#x2F;* Create pidfile *&#x2F;write_pidfile(server_data.pidfile);&#x2F;* if (!..) bb_perror_msg(&quot;can&#39;t create pidfile %s&quot;, pidfile); *&#x2F;bb_simple_info_msg(&quot;started, v&quot;BB_VER);option &#x3D; udhcp_find_option(server_data.options, DHCP_LEASE_TIME);server_data.max_lease_sec &#x3D; DEFAULT_LEASE_TIME;if (option) &#123;move_from_unaligned32(server_data.max_lease_sec, option-&gt;data + OPT_DATA);server_data.max_lease_sec &#x3D; ntohl(server_data.max_lease_sec);&#125;&#x2F;* Sanity check *&#x2F;num_ips &#x3D; server_data.end_ip - server_data.start_ip + 1;if (server_data.max_leases &gt; num_ips) &#123;bb_error_msg(&quot;max_leases&#x3D;%u is too big, setting to %u&quot;,(unsigned)server_data.max_leases, num_ips);server_data.max_leases &#x3D; num_ips;&#125;&#x2F;* this sets g_leases *&#x2F;SET_PTR_TO_GLOBALS(xzalloc(server_data.max_leases * sizeof(g_leases[0])));read_leases(server_data.lease_file);if (udhcp_read_interface(server_data.interface,&amp;server_data.ifindex,(server_data.server_nip &#x3D;&#x3D; 0 ? &amp;server_data.server_nip : NULL),server_data.server_mac)) &#123;retval &#x3D; 1;goto ret;&#125;&#x2F;*********  MAC限制 *********&#x2F;&#x2F;*解析mac限制ENABLE_UDHCPD_SET_HOSTMAC宏定义在include&#x2F;autoconf.h头文件中，该头文件make menuconfig配置后生成的头文件*&#x2F;#if ENABLE_UDHCPD_SET_HOSTMACint mask &#x3D;0;unsigned char mac[6] &#x3D; &#123;&#125;;int err &#x3D; parseHostMac(mac, &amp;mask);bb_info_msg(&quot;mask_mac %02x %02x %02x %02x %02x %02x  mask &#x3D; %x \n&quot;,mac[0],mac[1],mac[2],mac[3],mac[4],mac[5],mask);if(err) &#123;bb_info_msg(&quot;SET_HOSTMAC is error!\n&quot;);goto ret;&#125;#endif&#x2F;********* MAC限制 *********&#x2F; continue_with_autotime:timeout_end &#x3D; monotonic_sec() + server_data.auto_time;while (1) &#123; &#x2F;* loop until universe collapses *&#x2F;struct pollfd pfds[2];struct dhcp_packet packet;int bytes;int tv;uint8_t *server_id_opt;uint8_t *requested_ip_opt;uint32_t requested_nip;uint32_t static_lease_nip;struct dyn_lease *lease, fake_lease;if (server_socket &lt; 0) &#123;server_socket &#x3D; udhcp_listen_socket(&#x2F;*INADDR_ANY,*&#x2F; SERVER_PORT,server_data.interface);&#125;udhcp_sp_fd_set(pfds, server_socket); new_tv:tv &#x3D; -1;if (server_data.auto_time) &#123;tv &#x3D; timeout_end - monotonic_sec();if (tv &lt;&#x3D; 0) &#123; write_leases:write_leases();goto continue_with_autotime;&#125;tv *&#x3D; 1000;&#125;&#x2F;* Block here waiting for either signal or packet *&#x2F;retval &#x3D; poll(pfds, 2, tv);if (retval &lt;&#x3D; 0) &#123;if (retval &#x3D;&#x3D; 0)goto write_leases;if (errno &#x3D;&#x3D; EINTR)goto new_tv;&#x2F;* &lt; 0 and not EINTR: should not happen *&#x2F;bb_simple_perror_msg_and_die(&quot;poll&quot;);&#125;if (pfds[0].revents) switch (udhcp_sp_read()) &#123;case SIGUSR1:bb_info_msg(&quot;received %s&quot;, &quot;SIGUSR1&quot;);write_leases();&#x2F;* why not just reset the timeout, eh *&#x2F;goto continue_with_autotime;case SIGTERM:bb_info_msg(&quot;received %s&quot;, &quot;SIGTERM&quot;);write_leases();goto ret0;&#125;&#x2F;* Is it a packet? *&#x2F;if (!pfds[1].revents)continue; &#x2F;* no *&#x2F;&#x2F;* Note: we do not block here, we block on poll() instead. * Blocking here would prevent SIGTERM from working: * socket read inside this call is restarted on caught signals. *&#x2F;bytes &#x3D; udhcp_recv_kernel_packet(&amp;packet, server_socket);if (bytes &lt; 0) &#123;&#x2F;* bytes can also be -2 (&quot;bad packet data&quot;) *&#x2F;if (bytes &#x3D;&#x3D; -1 &amp;&amp; errno !&#x3D; EINTR) &#123;log1(&quot;read error: &quot;STRERROR_FMT&quot;, reopening socket&quot; STRERROR_ERRNO);close(server_socket);server_socket &#x3D; -1;&#125;continue;&#125;if (packet.hlen !&#x3D; 6) &#123;bb_info_msg(&quot;MAC length !&#x3D; 6%s&quot;, &quot;, ignoring packet&quot;);continue;&#125;if (packet.op !&#x3D; BOOTREQUEST) &#123;bb_info_msg(&quot;not a REQUEST%s&quot;, &quot;, ignoring packet&quot;);continue;&#125;state &#x3D; udhcp_get_option(&amp;packet, DHCP_MESSAGE_TYPE);if (state &#x3D;&#x3D; NULL || state[0] &lt; DHCP_MINTYPE || state[0] &gt; DHCP_MAXTYPE) &#123;bb_info_msg(&quot;no or bad message type option%s&quot;, &quot;, ignoring packet&quot;);continue;&#125;&#x2F;* Get SERVER_ID if present *&#x2F;server_id_opt &#x3D; udhcp_get_option32(&amp;packet, DHCP_SERVER_ID);if (server_id_opt) &#123;uint32_t server_id_network_order;move_from_unaligned32(server_id_network_order, server_id_opt);if (server_id_network_order !&#x3D; server_data.server_nip) &#123;&#x2F;* client talks to somebody else *&#x2F;log1(&quot;server ID doesn&#39;t match%s&quot;, &quot;, ignoring&quot;);continue;&#125;&#125;&#x2F;* Look for a static&#x2F;dynamic lease *&#x2F;static_lease_nip &#x3D; get_static_nip_by_mac(&amp;packet.chaddr);if (static_lease_nip) &#123;bb_info_msg(&quot;found static lease: %x&quot;, static_lease_nip);memcpy(&amp;fake_lease.lease_mac, &amp;packet.chaddr, 6);fake_lease.lease_nip &#x3D; static_lease_nip;fake_lease.expires &#x3D; 0;lease &#x3D; &amp;fake_lease;&#125; else &#123;&#x2F;********* MAC限制 *********&#x2F;&#x2F;*校验mac限制ENABLE_UDHCPD_SET_HOSTMAC宏定义在include&#x2F;autoconf.h头文件中，该头文件make menuconfig配置后生成的头文件*&#x2F;#if ENABLE_UDHCPD_SET_HOSTMACint i &#x3D; 0;for(i &#x3D; 0; i &lt; 6; i++)&#123;if(mask &amp; (0x1 &lt;&lt; i)) &#123;if(packet.chaddr[i] !&#x3D; mac[i])&#123;break;&#125;&#125;&#125;if(i !&#x3D; 6)&#123;continue;&#125;#endif&#x2F;********* MAC限制 *********&#x2F;lease &#x3D; find_lease_by_mac(packet.chaddr);bb_info_msg(&quot;mac:%02x:%02x:%02x:%02x:%02x:%02x \n&quot;, packet.chaddr[0], packet.chaddr[1], packet.chaddr[2], packet.chaddr[3], packet.chaddr[4], packet.chaddr[5]);&#125;&#x2F;* Get REQUESTED_IP if present *&#x2F;requested_nip &#x3D; 0;requested_ip_opt &#x3D; udhcp_get_option32(&amp;packet, DHCP_REQUESTED_IP);if (requested_ip_opt) &#123;move_from_unaligned32(requested_nip, requested_ip_opt);&#125;switch (state[0]) &#123;case DHCPDISCOVER:log1(&quot;received %s&quot;, &quot;DISCOVER&quot;);send_offer(&amp;packet, static_lease_nip, lease, requested_nip, arpping_ms);break;case DHCPREQUEST:log1(&quot;received %s&quot;, &quot;REQUEST&quot;);&#x2F;* RFC 2131:o DHCPREQUEST generated during SELECTING state:   Client inserts the address of the selected server in &#39;server   identifier&#39;, &#39;ciaddr&#39; MUST be zero, &#39;requested IP address&#39; MUST be   filled in with the yiaddr value from the chosen DHCPOFFER.   Note that the client may choose to collect several DHCPOFFER   messages and select the &quot;best&quot; offer.  The client indicates its   selection by identifying the offering server in the DHCPREQUEST   message.  If the client receives no acceptable offers, the client   may choose to try another DHCPDISCOVER message.  Therefore, the   servers may not receive a specific DHCPREQUEST from which they can   decide whether or not the client has accepted the offer.o DHCPREQUEST generated during INIT-REBOOT state:   &#39;server identifier&#39; MUST NOT be filled in, &#39;requested IP address&#39;   option MUST be filled in with client&#39;s notion of its previously   assigned address. &#39;ciaddr&#39; MUST be zero. The client is seeking to   verify a previously allocated, cached configuration. Server SHOULD   send a DHCPNAK message to the client if the &#39;requested IP address&#39;   is incorrect, or is on the wrong network.   Determining whether a client in the INIT-REBOOT state is on the   correct network is done by examining the contents of &#39;giaddr&#39;, the   &#39;requested IP address&#39; option, and a database lookup. If the DHCP   server detects that the client is on the wrong net (i.e., the   result of applying the local subnet mask or remote subnet mask (if   &#39;giaddr&#39; is not zero) to &#39;requested IP address&#39; option value   doesn&#39;t match reality), then the server SHOULD send a DHCPNAK   message to the client.   If the network is correct, then the DHCP server should check if   the client&#39;s notion of its IP address is correct. If not, then the   server SHOULD send a DHCPNAK message to the client. If the DHCP   server has no record of this client, then it MUST remain silent,   and MAY output a warning to the network administrator. This   behavior is necessary for peaceful coexistence of non-   communicating DHCP servers on the same wire.   If &#39;giaddr&#39; is 0x0 in the DHCPREQUEST message, the client is on   the same subnet as the server.  The server MUST broadcast the   DHCPNAK message to the 0xffffffff broadcast address because the   client may not have a correct network address or subnet mask, and   the client may not be answering ARP requests.   If &#39;giaddr&#39; is set in the DHCPREQUEST message, the client is on a   different subnet.  The server MUST set the broadcast bit in the   DHCPNAK, so that the relay agent will broadcast the DHCPNAK to the   client, because the client may not have a correct network address   or subnet mask, and the client may not be answering ARP requests.o DHCPREQUEST generated during RENEWING state:   &#39;server identifier&#39; MUST NOT be filled in, &#39;requested IP address&#39;   option MUST NOT be filled in, &#39;ciaddr&#39; MUST be filled in with   client&#39;s IP address. In this situation, the client is completely   configured, and is trying to extend its lease. This message will   be unicast, so no relay agents will be involved in its   transmission.  Because &#39;giaddr&#39; is therefore not filled in, the   DHCP server will trust the value in &#39;ciaddr&#39;, and use it when   replying to the client.   A client MAY choose to renew or extend its lease prior to T1.  The   server may choose not to extend the lease (as a policy decision by   the network administrator), but should return a DHCPACK message   regardless.o DHCPREQUEST generated during REBINDING state:   &#39;server identifier&#39; MUST NOT be filled in, &#39;requested IP address&#39;   option MUST NOT be filled in, &#39;ciaddr&#39; MUST be filled in with   client&#39;s IP address. In this situation, the client is completely   configured, and is trying to extend its lease. This message MUST   be broadcast to the 0xffffffff IP broadcast address.  The DHCP   server SHOULD check &#39;ciaddr&#39; for correctness before replying to   the DHCPREQUEST.   The DHCPREQUEST from a REBINDING client is intended to accommodate   sites that have multiple DHCP servers and a mechanism for   maintaining consistency among leases managed by multiple servers.   A DHCP server MAY extend a client&#39;s lease only if it has local   administrative authority to do so.*&#x2F;if (!requested_ip_opt) &#123;requested_nip &#x3D; packet.ciaddr;if (requested_nip &#x3D;&#x3D; 0) &#123;log1(&quot;no requested IP and no ciaddr%s&quot;, &quot;, ignoring&quot;);break;&#125;&#125;if (lease &amp;&amp; requested_nip &#x3D;&#x3D; lease-&gt;lease_nip) &#123;&#x2F;* client requested or configured IP matches the lease. * ACK it, and bump lease expiration time. *&#x2F;send_ACK(&amp;packet, lease-&gt;lease_nip);break;&#125;&#x2F;* No lease for this MAC, or lease IP !&#x3D; requested IP *&#x2F;if (server_id_opt    &#x2F;* client is in SELECTING state *&#x2F; || requested_ip_opt &#x2F;* client is in INIT-REBOOT state *&#x2F;) &#123;&#x2F;* &quot;No, we don&#39;t have this IP for you&quot; *&#x2F;send_NAK(&amp;packet);&#125; &#x2F;* else: client is in RENEWING or REBINDING, do not answer *&#x2F;break;case DHCPDECLINE:&#x2F;* RFC 2131: * &quot;If the server receives a DHCPDECLINE message, * the client has discovered through some other means * that the suggested network address is already * in use. The server MUST mark the network address * as not available and SHOULD notify the local * sysadmin of a possible configuration problem.&quot; * * SERVER_ID must be present, * REQUESTED_IP must be present, * chaddr must be filled in, * ciaddr must be 0 (we do not check this) *&#x2F;log1(&quot;received %s&quot;, &quot;DECLINE&quot;);if (server_id_opt &amp;&amp; requested_ip_opt &amp;&amp; lease  &#x2F;* chaddr matches this lease *&#x2F; &amp;&amp; requested_nip &#x3D;&#x3D; lease-&gt;lease_nip) &#123;memset(lease-&gt;lease_mac, 0, sizeof(lease-&gt;lease_mac));lease-&gt;expires &#x3D; time(NULL) + server_data.decline_time;&#125;break;case DHCPRELEASE:&#x2F;* &quot;Upon receipt of a DHCPRELEASE message, the server * marks the network address as not allocated.&quot; * * SERVER_ID must be present, * REQUESTED_IP must not be present (we do not check this), * chaddr must be filled in, * ciaddr must be filled in *&#x2F;log1(&quot;received %s&quot;, &quot;RELEASE&quot;);if (server_id_opt &amp;&amp; lease  &#x2F;* chaddr matches this lease *&#x2F; &amp;&amp; packet.ciaddr &#x3D;&#x3D; lease-&gt;lease_nip) &#123;lease-&gt;expires &#x3D; time(NULL);&#125;break;case DHCPINFORM:log1(&quot;received %s&quot;, &quot;INFORM&quot;);send_inform(&amp;packet);break;&#125;&#125; ret0:retval &#x3D; 0; ret:&#x2F;*if (server_data.pidfile) - server_data.pidfile is never NULL *&#x2F;remove_pidfile(server_data.pidfile);return retval;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> busybox </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> busybox </tag>
            
            <tag> romfs </tag>
            
            <tag> rootfs </tag>
            
            <tag> 文件系统 </tag>
            
            <tag> telnetd </tag>
            
            <tag> udhcpd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>udhcpc6嵌入式获取IPV6</title>
      <link href="/2023/08/02/udhcpc6-qian-ru-shi-huo-qu-ipv6/"/>
      <url>/2023/08/02/udhcpc6-qian-ru-shi-huo-qu-ipv6/</url>
      
        <content type="html"><![CDATA[<h4 id="获取命令"><a href="#获取命令" class="headerlink" title="获取命令"></a>获取命令</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">udhcpc6 -b -i -eth0<span class="token comment"># -s 可以指定dhcpc的脚本文件路径</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="default-script"><a href="#default-script" class="headerlink" title="default.script"></a>default.script</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">RESOLV_CONF</span><span class="token operator">=</span><span class="token string">"/etc/resolv.conf"</span><span class="token punctuation">[</span> -n <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span> <span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:Error: should be called from udhcpc"</span><span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token assign-left variable">NETMASK</span><span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">[</span> -n <span class="token string">"<span class="token variable">$subnet</span>"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">NETMASK</span><span class="token operator">=</span><span class="token string">"netmask <span class="token variable">$subnet</span>"</span><span class="token assign-left variable">BROADCAST</span><span class="token operator">=</span><span class="token string">"broadcast +"</span><span class="token punctuation">[</span> -n <span class="token string">"<span class="token variable">$broadcast</span>"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">BROADCAST</span><span class="token operator">=</span><span class="token string">"broadcast <span class="token variable">$broadcast</span>"</span><span class="token keyword">case</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token keyword">in</span>deconfig<span class="token punctuation">)</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:Setting IP address 0.0.0.0 on <span class="token variable">$interface</span>"</span><span class="token comment">#ifconfig $interface 0.0.0.0</span><span class="token punctuation">;</span><span class="token punctuation">;</span>renew<span class="token operator">|</span>bound<span class="token punctuation">)</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:Setting IP address <span class="token variable">$ipv6</span> on <span class="token variable">$interface</span>"</span><span class="token function">ifconfig</span> <span class="token variable">$interface</span> <span class="token variable">$ipv6</span> <span class="token variable">$NETMASK</span> <span class="token variable">$BROADCAST</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$interface</span> <span class="token operator">!=</span> <span class="token string">"eth0"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span> <span class="token variable">$interface</span> <span class="token operator">!=</span> <span class="token string">"bond0"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span> <span class="token variable">$interface</span> <span class="token operator">!=</span> <span class="token string">"wlan0"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:<span class="token variable">$interface</span> is not allowd set router"</span><span class="token builtin class-name">exit</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:set router for <span class="token variable">$interface</span>"</span><span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span> -n <span class="token string">"<span class="token variable">$router</span>"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:Deleting routers"</span><span class="token keyword">while</span> route del default gw <span class="token number">0.0</span>.0.0 dev <span class="token variable">$interface</span> <span class="token punctuation">;</span> <span class="token keyword">do</span><span class="token builtin class-name">:</span><span class="token keyword">done</span><span class="token assign-left variable">metric</span><span class="token operator">=</span><span class="token number">0</span><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable">$router</span> <span class="token punctuation">;</span> <span class="token keyword">do</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc6:Adding router <span class="token variable">$i</span>"</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$subnet</span>"</span> <span class="token operator">=</span> <span class="token string">"255.255.255.255"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token comment"># special case for /32 subnets:</span><span class="token comment"># /32 instructs kernel to always use routing for all outgoing packets</span><span class="token comment"># (they can never be sent to local subnet - there is no local subnet for /32).</span><span class="token comment"># Used in datacenters, avoids the need for private ip-addresses between two hops.</span><span class="token function">ip</span> route <span class="token function">add</span> <span class="token variable">$i</span> dev <span class="token variable">$interface</span><span class="token keyword">fi</span>route <span class="token function">add</span> default gw <span class="token variable">$i</span> dev <span class="token variable">$interface</span> metric <span class="token variable"><span class="token variable">$((</span>metric<span class="token operator">++</span><span class="token variable">))</span></span><span class="token keyword">done</span><span class="token keyword">fi</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc:Recreating <span class="token variable">$RESOLV_CONF</span>"</span><span class="token assign-left variable">tmpfile</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$RESOLV_CONF</span>"</span><span class="token operator">></span> <span class="token string">"<span class="token variable">$tmpfile</span>"</span><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable">$dns</span> <span class="token punctuation">;</span> <span class="token keyword">do</span><span class="token builtin class-name">echo</span> <span class="token string">"udhcpc: Adding DNS server <span class="token variable">$i</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"nameserver <span class="token variable">$i</span>"</span> <span class="token operator">>></span> <span class="token string">"<span class="token variable">$tmpfile</span>"</span><span class="token keyword">done</span><span class="token function">mv</span> <span class="token string">"<span class="token variable">$tmpfile</span>"</span> <span class="token string">"<span class="token variable">$RESOLV_CONF</span>"</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token keyword">esac</span><span class="token builtin class-name">exit</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> 网络 </tag>
            
            <tag> udhcpc6 </tag>
            
            <tag> ipv6 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IPV6服务器搭建</title>
      <link href="/2023/08/02/ipv6-fu-wu-qi-da-jian/"/>
      <url>/2023/08/02/ipv6-fu-wu-qi-da-jian/</url>
      
        <content type="html"><![CDATA[<h3 id="IPV6服务器搭建"><a href="#IPV6服务器搭建" class="headerlink" title="IPV6服务器搭建"></a>IPV6服务器搭建</h3><p>搭建环境：ubuntu<br>使用工具：isc-dhcp-server、radvd</p><h4 id="一、虚拟机配置"><a href="#一、虚拟机配置" class="headerlink" title="一、虚拟机配置"></a>一、虚拟机配置</h4><p><img "" class="lazyload placeholder" data-original="/photo/ipv6server/ubuntuNetSet.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>虚拟机需要配置网络为桥接。<br>主要目的是为了，让该虚拟机能给所在的局域网设备自动分配ipv6</p><h4 id="二、isc-dhcp-server工具安装"><a href="#二、isc-dhcp-server工具安装" class="headerlink" title="二、isc-dhcp-server工具安装"></a>二、isc-dhcp-server工具安装</h4><p>dhcpd工具主要用于和udhcpc6交互，分配ipv6给客户端<br>1、安装isc-dhcp-server工具</p><p>```bash<br>sudo apt update<br>sudo apt install isc-dhcp-server</p><pre class="line-numbers language-none"><code class="language-none">&#96;&#96;&#96;&#96;bash#安装过程可能会看到因为一些什么奇怪的锁,如下所示,可以根据提示kill掉对应的进程或者强制解锁直接删除文件。Unable to acquire the dpkg frontend lock#杀掉占用的进程sudo kill PID#强制解锁sudo rm &#x2F;var&#x2F;cache&#x2F;apt&#x2F;archives&#x2F;locksudo rm &#x2F;var&#x2F;lib&#x2F;dpkg&#x2F;lock<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2、配置dhcpd配置文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#打开/etc/dhcp/dhcpd6.conf文件，若没有则创建</span><span class="token comment">#打开该文件的时候可能会遇到文件只读无法写使用下面命令即可</span><span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">777</span> /etc/dhcp/dhcpd6.conf<span class="token comment">#dhcpd6.conf配置</span><span class="token comment"># Server configuration file example for DHCPv6</span><span class="token comment"># From the file used for TAHI tests - addresses chosen</span><span class="token comment"># to match TAHI rather than example block.</span><span class="token comment"># IPv6 address valid lifetime</span><span class="token comment">#  (at the end the address is no longer usable by the client)</span><span class="token comment">#  (set to 30 days, the usual IPv6 default)</span>default-lease-time <span class="token number">2592000</span><span class="token punctuation">;</span><span class="token comment"># IPv6 address preferred lifetime</span><span class="token comment">#  (at the end the address is deprecated, i.e., the client should use</span><span class="token comment">#   other addresses for new connections)</span><span class="token comment">#  (set to 7 days, theusual IPv6 default)</span>preferred-lifetime <span class="token number">604800</span><span class="token punctuation">;</span><span class="token comment"># T1, the delay before Renew</span><span class="token comment">#  (default is 1/2 preferred lifetime)</span><span class="token comment">#  (set to 1 hour)</span>option dhcp-renewal-time <span class="token number">3600</span><span class="token punctuation">;</span><span class="token comment"># T2, the delay before Rebind (if Renews failed)</span><span class="token comment">#  (default is 3/4 preferred lifetime)</span><span class="token comment">#  (set to 2 hours)</span>option dhcp-rebinding-time <span class="token number">7200</span><span class="token punctuation">;</span><span class="token comment"># Enable RFC 5007 support (same than for DHCPv4)</span>allow leasequery<span class="token punctuation">;</span><span class="token comment"># Global definitions for name server address(es) and domain search list</span>option dhcp6.name-servers 3ffe:501:ffff:100:200:ff:fe00:3f3e<span class="token punctuation">;</span>option dhcp6.domain-search <span class="token string">"test.example.com"</span>,<span class="token string">"example.com"</span><span class="token punctuation">;</span><span class="token comment"># Set preference to 255 (maximum) in order to avoid waiting for</span><span class="token comment"># additional servers when there is only one</span><span class="token comment">##option dhcp6.preference 255;</span><span class="token comment"># Server side command to enable rapid-commit (2 packet exchange)</span><span class="token comment">##option dhcp6.rapid-commit;</span><span class="token comment"># The delay before information-request refresh</span><span class="token comment">#  (minimum is 10 minutes, maximum one day, default is to not refresh)</span><span class="token comment">#  (set to 6 hours)</span>option dhcp6.info-refresh-time <span class="token number">21600</span><span class="token punctuation">;</span><span class="token comment"># Static definition (must be global)</span><span class="token comment">#host myclient &#123;</span><span class="token comment">## The entry is looked up by this</span><span class="token comment">#host-identifier option</span><span class="token comment">#dhcp6.client-id 00:01:00:01:00:04:93:e0:00:00:00:00:a2:a2;</span><span class="token comment">#</span><span class="token comment">## A fixed address</span><span class="token comment">#fixed-address6 3ffe:501:ffff:100::1234;</span><span class="token comment">#</span><span class="token comment">## A fixed prefix</span><span class="token comment">#fixed-prefix6 3ffe:501:ffff:101::/64;</span><span class="token comment">#</span><span class="token comment">## Override of the global definitions,</span><span class="token comment">## works only when a resource (address or prefix) is assigned</span><span class="token comment">#option dhcp6.name-servers 3ffe:501:ffff:100:200:ff:fe00:4f4e;</span><span class="token comment">#</span><span class="token comment">## For debug (to see when the entry statements are executed)</span><span class="token comment">##  (log "sol" when a matching Solicitation is received)</span><span class="token comment">###if packet(0,1) = 1 &#123; log(debug,"sol"); &#125;</span><span class="token comment">#&#125;</span><span class="token comment">#</span><span class="token comment">#host otherclient &#123;</span><span class="token comment">#        # This host entry is hopefully matched if the client supplies a DUID-LL</span><span class="token comment">#        # or DUID-LLT containing this MAC address.</span><span class="token comment">#        hardware ethernet 01:00:80:a2:55:67;</span><span class="token comment">#</span><span class="token comment">#        fixed-address6 3ffe:501:ffff:100::4321;</span><span class="token comment">#&#125;</span>subnet6 <span class="token number">2001</span>:db8:1:0::/64 <span class="token punctuation">&#123;</span>range6 <span class="token number">2001</span>:db8:1:0::50 <span class="token number">2001</span>:db8:1:0::100<span class="token punctuation">;</span>option dhcp6.name-servers <span class="token number">2001</span>:4860:4860::8888<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment"># The subnet where the server is attached</span><span class="token comment">#  (i.e., the server has an address in this subnet)</span><span class="token comment">#subnet6 3ffe:501:ffff:100::/64 &#123;</span><span class="token comment">## Two addresses available to clients</span><span class="token comment">##  (the third client should get NoAddrsAvail)</span><span class="token comment">#range6 3ffe:501:ffff:100::10 3ffe:501:ffff:100::11;</span><span class="token comment">#</span><span class="token comment">## Use the whole /64 prefix for temporary addresses</span><span class="token comment">##  (i.e., direct application of RFC 4941)</span><span class="token comment">#range6 3ffe:501:ffff:100:: temporary;</span><span class="token comment">#</span><span class="token comment">## Some /64 prefixes available for Prefix Delegation (RFC 3633)</span><span class="token comment">#prefix6 3ffe:501:ffff:100:: 3ffe:501:ffff:111:: /64;</span><span class="token comment">#&#125;</span><span class="token comment"># A second subnet behind a relay agent</span><span class="token comment">#subnet6 3ffe:501:ffff:101::/64 &#123;</span><span class="token comment">#range6 3ffe:501:ffff:101::10 3ffe:501:ffff:101::11;</span><span class="token comment">#</span><span class="token comment">## Override of the global definitions,</span><span class="token comment">## works only when a resource (address or prefix) is assigned</span><span class="token comment">#option dhcp6.name-servers 3ffe:501:ffff:101:200:ff:fe00:3f3e;</span><span class="token comment">#</span><span class="token comment">#&#125;</span><span class="token comment"># A third subnet behind a relay agent chain</span><span class="token comment">#subnet6 3ffe:501:ffff:102::/64 &#123;</span><span class="token comment">#range6 3ffe:501:ffff:102::10 3ffe:501:ffff:102::11;</span><span class="token comment">#&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="三、radvd工具安装"><a href="#三、radvd工具安装" class="headerlink" title="三、radvd工具安装"></a>三、radvd工具安装</h4><p>radvd工具主要用于广播网关</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> radvd<span class="token comment">#创建/etc/radvd.conf，若有则无需创建</span><span class="token comment">#添加读写权限</span><span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">777</span> /etc/radvd.conf<span class="token comment">#配置/etc/radvd.conf文件</span>interface ens33<span class="token punctuation">&#123;</span>AdvSendAdvert on<span class="token punctuation">;</span>MinRtrAdvInterval <span class="token number">30</span><span class="token punctuation">;</span>MaxRtrAdvInterval <span class="token number">600</span><span class="token punctuation">;</span>AdvManagedFlag on<span class="token punctuation">;</span>AdvOtherConfigFlag on<span class="token punctuation">;</span>AdvLinkMTU <span class="token number">1500</span><span class="token punctuation">;</span>AdvSourceLLAddress on<span class="token punctuation">;</span>AdvDefaultPreference high<span class="token punctuation">;</span>prefix <span class="token number">2001</span>:db8:1:0::/64<span class="token punctuation">&#123;</span>AdvOnLink on<span class="token punctuation">;</span>AdvAutonomous off<span class="token punctuation">;</span>AdvRouterAddr on<span class="token punctuation">;</span>AdvPreferredLifetime <span class="token number">3600</span><span class="token punctuation">;</span>AdvValidLifetime <span class="token number">7200</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>route <span class="token number">2001</span>:db8:1:0::/64<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="四、启动服务"><a href="#四、启动服务" class="headerlink" title="四、启动服务"></a>四、启动服务</h4><p>1、启动radvd服务</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">service</span> radvd start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/ipv6server/radvd.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="radvd启动成功"><br>2、启动dhcpd服务</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#设置ubuntu的ipv6 ip</span><span class="token function">sudo</span> <span class="token function">ifconfig</span> ens33 inet6 <span class="token function">add</span> <span class="token number">2001</span>:db8:1:0::1/64<span class="token comment">#启动dhcpd</span><span class="token function">sudo</span> dhcpd -6 -d -cf /etc/dhcp/dhcpd6.conf ens33<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/ipv6server/dhcpd6.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="启动过程及分配ipv6打印"></p>]]></content>
      
      
      <categories>
          
          <category> 网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> 网络 </tag>
            
            <tag> ipv6 </tag>
            
            <tag> dhcpd </tag>
            
            <tag> radvd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux usb设备数量和类型识别</title>
      <link href="/2022/07/16/linux-usb-she-bei-shu-liang-he-lei-xing-shi-bie/"/>
      <url>/2022/07/16/linux-usb-she-bei-shu-liang-he-lei-xing-shi-bie/</url>
      
        <content type="html"><![CDATA[<h4 id="一、整体思路"><a href="#一、整体思路" class="headerlink" title="一、整体思路"></a>一、整体思路</h4><p>1、获取 /sys/bus/usb/devices 目录下文件信息。如下所示<br><img "" class="lazyload placeholder" data-original="/photo/usbinfo/1.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>2、例如 1-1 usb设备信息，可以通过命令ls 1-1查看 </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> <span class="token number">1</span>-1<span class="token number">1</span>-1:1.0              bmAttributes         manufacturerauthorized           busnum               maxchildavoid_reset_quirk    configuration        portbConfigurationValue  descriptors          productbDeviceClass         dev                  quirksbDeviceProtocol      devnum               removablebDeviceSubClass      devpath              removebMaxPacketSize0      driver               speedbMaxPower            ep_00                subsystembNumConfigurations   idProduct            ueventbNumInterfaces       idVendor             urbnumbcdDevice            ltm_capable          version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/usbinfo/2.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>其中product中就是该usb设备类型<br>3、获取usb设备类型</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /1-1/productAltoBeam_WIFI<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/usbinfo/3.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>返回显示该设备是一个usb wifi。</p><p>因此要知道设备上的usb设备数量以及类型就需要对这些文件进行读取。</p><h4 id="二、代码实现"><a href="#二、代码实现" class="headerlink" title="二、代码实现"></a>二、代码实现</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYS_USB_INFO</span>  <span class="token string">"/sys/bus/usb/devices"</span></span><span class="token keyword">static</span> UsbType_s g_astUsbType<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    XM_CHAR aPort<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    XM_CHAR aType<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> UsbType_s<span class="token punctuation">;</span><span class="token comment">//获取usb设备类型,成功返回 0 ；失败返回 -1；</span><span class="token keyword">static</span> XM_S32 <span class="token function">Usb_getState</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> pPath<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> pType<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    DIR <span class="token operator">*</span>pstDir <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">stat</span> ststat<span class="token punctuation">;</span>        <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span>pstDirent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    XM_CHAR aFileName<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    XM_S32 fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    XM_S32 ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        pstDir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>pPath<span class="token punctuation">)</span><span class="token punctuation">;</span>    pstDirent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pstDirent<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"product"</span><span class="token punctuation">,</span>pstDirent<span class="token operator">-></span>d_name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>aFileName<span class="token punctuation">,</span>pPath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcat</span><span class="token punctuation">(</span>aFileName<span class="token punctuation">,</span><span class="token string">"/product"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>aFileName<span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">stat</span><span class="token punctuation">(</span>aFileName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ststat<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> pType<span class="token punctuation">,</span>ststat<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">&#123;</span>                    ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        pstDirent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">closedir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> ret<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//获取usb接口设备连接数以及设备类型</span><span class="token comment">//有usb设备返回0，失败返回-1,pNum返回usb设备个数，ppstUsbType是usb设备信息</span>XM_S32 <span class="token function">LibXmDvr_Usb_getState</span><span class="token punctuation">(</span>XM_S32 <span class="token operator">*</span>pNum<span class="token punctuation">,</span>UsbType_s<span class="token operator">*</span><span class="token operator">*</span> ppstUsbType<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    DIR <span class="token operator">*</span>pstDir<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span>pstDirent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    XM_CHAR aPath<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    XM_CHAR aType<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    XM_S32 index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    pstDir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>SYS_USB_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>    pstDirent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pstDirent<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>         <span class="token function">memset</span><span class="token punctuation">(</span>aPath<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>aPath<span class="token punctuation">,</span>SYS_USB_INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcat</span><span class="token punctuation">(</span>aPath<span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">strcat</span><span class="token punctuation">(</span>aPath<span class="token punctuation">,</span>pstDirent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">memset</span><span class="token punctuation">(</span>aType<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">Usb_getState</span><span class="token punctuation">(</span>aPath<span class="token punctuation">,</span>aType<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> index <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>aType<span class="token punctuation">,</span><span class="token string">"usbhc-nvtivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>                pstDirent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>g_astUsbType<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>aPort<span class="token punctuation">,</span>pstDirent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>g_astUsbType<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>aType<span class="token punctuation">,</span>aType<span class="token punctuation">)</span><span class="token punctuation">;</span>            index<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        pstDirent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token function">closedir</span><span class="token punctuation">(</span>pstDir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span>pNum <span class="token operator">=</span> index<span class="token punctuation">;</span>    <span class="token operator">*</span>ppstUsbType <span class="token operator">=</span> g_astUsbType<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>index <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>index <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> linux </tag>
            
            <tag> usb </tag>
            
            <tag> 目录获取 </tag>
            
            <tag> readdir </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>命令读写寄存器</title>
      <link href="/2022/06/30/ming-ling-du-xie-ji-cun-qi/"/>
      <url>/2022/06/30/ming-ling-du-xie-ji-cun-qi/</url>
      
        <content type="html"><![CDATA[<h4 id="一、devmem"><a href="#一、devmem" class="headerlink" title="一、devmem"></a>一、devmem</h4><p>读寄存器 0xfc203000</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">devmem  寄存器地址  数据长度（最大64位）devmem  0xfc203000  <span class="token number">32</span>0x11a2e291<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>写寄存器</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">devmem  寄存器地址  数据长度  要写入数据devmem  0xfc203000  <span class="token number">32</span>  0xaa12e2f5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="二、himm海思工具"><a href="#二、himm海思工具" class="headerlink" title="二、himm海思工具"></a>二、himm海思工具</h4><p>读寄存器 0xfc203000</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">himm  寄存器地址  himm  0xfc203000 0x11a2e291<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>写寄存器</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">himm  寄存器地址   要写入数据himm  0xfc203000  0xaa12e2f5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> devmem </tag>
            
            <tag> 读写寄存器 </tag>
            
            <tag> himm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>curl交叉编译</title>
      <link href="/2022/06/19/curl-jiao-cha-bian-yi/"/>
      <url>/2022/06/19/curl-jiao-cha-bian-yi/</url>
      
        <content type="html"><![CDATA[<h4 id="一、下载curl源码"><a href="#一、下载curl源码" class="headerlink" title="一、下载curl源码"></a>一、下载curl源码</h4><p><a href="https://curl.se/download/">curl官网</a></p><h4 id="二、交叉编译"><a href="#二、交叉编译" class="headerlink" title="二、交叉编译"></a>二、交叉编译</h4><h5 id="1、解压"><a href="#1、解压" class="headerlink" title="1、解压"></a>1、解压</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> -xzvf curl-7.82.0.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="2、配置交叉编译"><a href="#2、配置交叉编译" class="headerlink" title="2、配置交叉编译"></a>2、配置交叉编译</h4><p>以联咏NT98331平台为例</p><div class="note info"><p>–prefix 指定编译安装目录</p></div><div class="note info"><p>–disable-threaded-resolver 应该和线程有关，安装时报了 Threaded resolver enabled butno thread library found 这个错，所以禁用了} {% note info</p></div><div class="note info"><p>–with-ssl 指定ssl目录。</p></div><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure --target<span class="token operator">=</span>arm-ca53-linux --host<span class="token operator">=</span>arm-ca53-linux  --prefix<span class="token operator">=</span>/home/liyongli/SVN/curl331 --disable-threaded-resolver <span class="token assign-left variable">CC</span><span class="token operator">=</span>arm-ca53-linux-uclibcgnueabihf-novatek-8.4-gcc --with-ssl<span class="token operator">=</span>/home/liyongli/SVN/openssl331 --enable-static  -disable-dict --disable-ftp --disable-imap --disable-ldap --disable-ldaps --disable-pop3 --disable-proxy --disable-rtsp --disable-smtp --disable-telnet --disable-tftp --disable-zlib --without-ca-bundle --without-gnutls --without-libidn --without-librtmp --without-libssh2 --without-nss --without-zlib<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>配置完成，编译</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这样编译是动态库链接编译，如果需要静态编译，得到不依赖库，的可执行curl工具还需要修改文件<br>修改 curl-7.82.0/Makefile 和 curl-7.82.0/src/Makefile文件中,CFLAGS编译参数添加-static -static-libgcc</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">CFLAGS <span class="token operator">=</span> -Werror-implicit-function-declaration -O2 -Wno-system-headers -static -static-libgcc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>还需要删除编译出来openssl库中的动态库，既可以静态编译curl可执行程序。</p><p><a href="https://marysufer.com/2022/06/18/openssl-jiao-cha-bian-yi/">opessl交叉编译</a></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> 交叉编译 </tag>
            
            <tag> curl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openssl交叉编译</title>
      <link href="/2022/06/18/openssl-jiao-cha-bian-yi/"/>
      <url>/2022/06/18/openssl-jiao-cha-bian-yi/</url>
      
        <content type="html"><![CDATA[<h4 id="一、下载openssl源码"><a href="#一、下载openssl源码" class="headerlink" title="一、下载openssl源码"></a>一、下载openssl源码</h4><p><a href="">github3.0.1版本</a><br><a href="https://www.openssl.org/">openssl官网</a><br><img "" class="lazyload placeholder" data-original="/photo/openssl/1.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br><img "" class="lazyload placeholder" data-original="/photo/openssl/2.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><h4 id="二、交叉编译"><a href="#二、交叉编译" class="headerlink" title="二、交叉编译"></a>二、交叉编译</h4><h5 id="1、解压"><a href="#1、解压" class="headerlink" title="1、解压"></a>1、解压</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> -xzvf openssl-3.0.1.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="2、配置交叉编译"><a href="#2、配置交叉编译" class="headerlink" title="2、配置交叉编译"></a>2、配置交叉编译</h5><p>以联咏NT98331平台为例</p><div class="note info"><p>no-asm 关于汇编的模块不进行编译</p></div><div class="note info"><p>shared 编译成动态链接库</p></div><div class="note info"><p>no-async 不编译异步相关函数</p></div><div class="note info"><p>–prefix 指定编译结果目录即安装目录</p></div><div class="note info"><p>–cross-compile-prefix 指定交叉编译器及其路径，下面是交叉编译器已经再环境变量申明</p></div><div class="note info"><p>CC 配置编译器</p></div><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./Configure no-asm shared no-async --prefix<span class="token operator">=</span>/home/liyongli/SVN/openssl331 --cross-compile-prefix<span class="token operator">=</span>arm-ca53-linux-uclibcgnueabihf-novatek-8.4- <span class="token assign-left variable">CC</span><span class="token operator">=</span>gcc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>配置完成<br><img "" class="lazyload placeholder" data-original="/photo/openssl/3.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><p>打开Makefile，删除 -m64<br>有些编译器问题可能无法编译64位，且去除 -m64也不行只能修改源码。在include\openssl\bn.h该文件中修改</p><pre class="line-numbers language-C" data-language="C"><code class="language-C"># ifdef SIXTY_FOUR_BIT_LONG#  define BN_ULONG        unsigned long#  define BN_BYTES        8# endif&#x2F;* * 64-bit processor other than LP64 ABI *&#x2F;# ifdef SIXTY_FOUR_BIT#  define BN_ULONG        unsigned long long#  define BN_BYTES        8# endif&#x2F;*MN63 平台编译器需要锁定位32位#undef SIXTY_FOUR_BIT#undef SIXTY_FOUR_BIT_LONG#define THIRTY_TWO_BIT*&#x2F;# ifdef THIRTY_TWO_BIT#  define BN_ULONG        unsigned int#  define BN_BYTES        4# endif# define BN_BITS2       (BN_BYTES * 8)# define BN_BITS        (BN_BITS2 * 2)# define BN_TBIT        ((BN_ULONG)1 &lt;&lt; (BN_BITS2 - 1))# define BN_FLG_MALLOCED         0x01# define BN_FLG_STATIC_DATA      0x02<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/openssl/4.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><p>先后执行make 和 make install即可完成编译</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span><span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> 交叉编译 </tag>
            
            <tag> openssl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iptables网络共享</title>
      <link href="/2022/04/13/iptables-wang-luo-gong-xiang/"/>
      <url>/2022/04/13/iptables-wang-luo-gong-xiang/</url>
      
        <content type="html"><![CDATA[<h2 id="实现在嵌入式平台内网共享"><a href="#实现在嵌入式平台内网共享" class="headerlink" title="实现在嵌入式平台内网共享"></a>实现在嵌入式平台内网共享</h2><p>A设备有外网<br>B设备无外网<br>使用iptables nat转发，实现A设备给B设备提供网络</p><h3 id="一、内核添加iptables选项支持"><a href="#一、内核添加iptables选项支持" class="headerlink" title="一、内核添加iptables选项支持"></a>一、内核添加iptables选项支持</h3><p>按照下图中选项配置内核iptables支持。<br><img "" class="lazyload placeholder" data-original="/photo/iptables/kernel_1.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br><img "" class="lazyload placeholder" data-original="/photo/iptables/kernel_2.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br><img "" class="lazyload placeholder" data-original="/photo/iptables/kernel_3.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><h3 id="二、iptables工具编译"><a href="#二、iptables工具编译" class="headerlink" title="二、iptables工具编译"></a>二、iptables工具编译</h3><p>示例中选择的时iptables1.6.2版本。(<a href="https://www.netfilter.org/">iptables源码下载</a>)</p><p><font color='red'> 注意：需要修改 configure文件中文件地址,否则使用时可能出现 “Fatal: can’t open lock file /run/xtables.lock: No such file or directory”报。<br>        旧：xt_lock_name=”/run/xtables.lock”<br>        新：xt_lock_name=”/mnt/mtd/xtables.lock”</font> </p><p>交叉编译命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure --prefix<span class="token operator">=</span>/home/lyl/SVN/iptables16 --host<span class="token operator">=</span>arm-ca9-linux <span class="token assign-left variable">CC</span><span class="token operator">=</span>arm-ca9-linux-uclibcgnueabihf-gcc  --disable-nftables<span class="token function">make</span><span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>–prefix=/home/lyl/SVN/iptables16配置的是编译后的文件保存路径</p><p>CC=arm-ca9-linux-uclibcgnueabihf-gcc配置NT98321交叉编译器</p><p>–disable-nftables 去除该选项，不去除可能会存在如下报错</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">checking <span class="token keyword">for</span> libmnl<span class="token punctuation">..</span>. no*** Error: No suitable libmnl found. ***    Please <span class="token function">install</span> the <span class="token string">'libmnl'</span> package    Or consider --disable-nftables to skip    iptables-compat over nftables support.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="三、iptales-nat转发"><a href="#三、iptales-nat转发" class="headerlink" title="三、iptales nat转发"></a>三、iptales nat转发</h3><h4 id="1、配置环境变量"><a href="#1、配置环境变量" class="headerlink" title="1、配置环境变量"></a>1、配置环境变量</h4><p>将iptales编译完成的bin目录下文件打包倒usr/sbin文件目录下，将lib文件打包倒usr/lib目录下。添加环境变量。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">XTABLES_LIBDIR</span><span class="token operator">=</span>/usr/lib/xtables<span class="token builtin class-name">export</span> <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span>/usr/local/lib:/usr/lib<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><font color='red'>如果没有给环境变量可能会导致iptables 一些操作命令无法正常使用，遇到过 –to-source 的报错</font> </p><h4 id="2、配置设备ip"><a href="#2、配置设备ip" class="headerlink" title="2、配置设备ip"></a>2、配置设备ip</h4><p>A设备：eth3为usb 4g模块上网，eth0有线网口,假设4g的ip为10.24.131.49<br>B设备：eth0有线网口</p><p>A设备ip配置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">netinit <span class="token number">192.168</span>.2.1 <span class="token number">255.255</span>.255.0 <span class="token number">192.168</span>.2.254<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>B设备ip配置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">netinit <span class="token number">192.168</span>.2.3 <span class="token number">255.255</span>.255.0 <span class="token number">192.168</span>.2.254<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><a href="https://wangchujiang.com/linux-command/c/iptables.html#%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6">iptables命令使用详解</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 打开linux内核的nat转发功能</span><span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/net/ipv4/ip_forward<span class="token comment">#SNAT源地址转换，将来自B设备在这个ip范围内 192.168.2.2/24的地址转换为10.24.131.49</span>iptables -t nat -A POSTROUTING -s <span class="token number">192.168</span>.2.2/24 -o eth3 -j SNAT --to-source <span class="token number">10.24</span>.131.49或（4g 5gip可能会发生变化不固定，让系统自动获取ip）iptables -t nat -A POSTROUTING -s <span class="token number">192.168</span>.2.2/24  -o eth3 -j MASQUERADE<span class="token comment">#上网控制，允许192.168.2.1/24范围的ip访问网络</span>iptables -A FORWARD -s <span class="token number">192.168</span>.2.1/24 -j ACCEPT<span class="token comment">#在B设备</span><span class="token function">ping</span> <span class="token number">192.168</span>.2.1  （ping网关能通）<span class="token function">ping</span> www.baidu.com <span class="token punctuation">(</span>可能存在无法ping通，可能由于dns解析配置文件导致，检查配置该 /etc/resolv.cond 文件<span class="token punctuation">)</span><span class="token comment">#在A设备，遇到过无法ping通B设备，原因可能是路由表导致，输入route命令，查看路由表</span><span class="token comment">#中显示的默认网关，B设备默认网关应当是192.168.2.1（gateway）,（flags）UG。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> iptables </tag>
            
            <tag> linux </tag>
            
            <tag> 网络 </tag>
            
            <tag> 内网共享 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>链式队列</title>
      <link href="/2021/07/17/lian-shi-dui-lie/"/>
      <url>/2021/07/17/lian-shi-dui-lie/</url>
      
        <content type="html"><![CDATA[<h3 id="链式队列"><a href="#链式队列" class="headerlink" title="链式队列"></a>链式队列</h3><p>链式队列–使用链表模拟实现队列先进先出，主要由一个一个数据节点连接而成。下面代码封装了两种模式队列<br>一、更具入队出队改变队列长度，动态分配内存，以及节点内存大小也是动态更具需要分配<br>二、初始化为定长，节点空间固定大小，连接成环形队列。</p><span id="more"></span><h3 id="图解两种模式队列"><a href="#图解两种模式队列" class="headerlink" title="图解两种模式队列"></a>图解两种模式队列</h3><div class="tabs" id="tab-id"><ul class="nav-tabs"><li class="tab active"><a class="#tab-id-1">动态分配内存</a></li><li class="tab"><a class="#tab-id-2">固定内存环形队列</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-id-1"><p><img "" class="lazyload placeholder" data-original="/photo/queue/init1.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="初始化"><br><img "" class="lazyload placeholder" data-original="/photo/queue/push1.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="入队"><br><img "" class="lazyload placeholder" data-original="/photo/queue/pop1.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="出队"></p></div><div class="tab-pane" id="tab-id-2"><p><img "" class="lazyload placeholder" data-original="/photo/queue/init2.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="初始化"><br><img "" class="lazyload placeholder" data-original="/photo/queue/push2.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="入队"><br><img "" class="lazyload placeholder" data-original="/photo/queue/pop2.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="出队"></p></div></div></div><div class="tabs" id="tab-id"><ul class="nav-tabs"><li class="tab active"><a class="#tab-id-1">queue.h</a></li><li class="tab"><a class="#tab-id-2">queue.c</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-id-1"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__QUEUE_PUBLIC_H__</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__QUEUE_PUBLIC_H__</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  Type<span class="token punctuation">;</span><span class="token comment">//链表节点</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">&#123;</span>Type<span class="token operator">*</span> buff<span class="token punctuation">;</span><span class="token class-name">size_t</span> len<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token operator">*</span> next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>Node<span class="token punctuation">;</span><span class="token comment">//链表</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">QueueList</span><span class="token punctuation">&#123;</span><span class="token class-name">pthread_mutex_t</span> mutex_lock<span class="token punctuation">;</span><span class="token comment">//互斥锁防止同时出队，和入队活着一个出队一个入队时出现不同步</span><span class="token class-name">size_t</span> res<span class="token punctuation">;</span><span class="token comment">//记录链表节点总个数</span><span class="token class-name">size_t</span> size<span class="token punctuation">;</span><span class="token comment">//记录每个节点buff空间大小</span>Node<span class="token operator">*</span> head<span class="token punctuation">;</span>Node<span class="token operator">*</span> tail<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>QueueList<span class="token punctuation">;</span><span class="token comment">//初始化链式队列</span><span class="token keyword">int</span> <span class="token function">queuelist_init</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span><span class="token operator">*</span> queue<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建节点</span>Node<span class="token operator">*</span> <span class="token function">node_create</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span>Type<span class="token operator">*</span> buff<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//队列为空</span><span class="token keyword">int</span> <span class="token function">is_qempty</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//队列满</span><span class="token keyword">int</span> <span class="token function">is_qfull</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//队列字符串个数</span><span class="token keyword">int</span> <span class="token function">queuelist_num</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//入队(尾添加)</span><span class="token keyword">int</span> <span class="token function">Push_QueueList</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span>Type<span class="token operator">*</span> buff<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//出队(头删除)</span><span class="token keyword">int</span> <span class="token function">Pop_QueueList</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span>Type<span class="token operator">*</span> buff<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清空队列中数据</span><span class="token keyword">void</span> <span class="token function">clean_queuelist</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//销毁队列</span><span class="token keyword">int</span> <span class="token function">destroy_queuelist</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span><span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><div class="tab-pane" id="tab-id-2"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"queue.h"</span></span><span class="token comment">//初始化链式队列，len，size 都为0创建变长队列，都不为0创建len长度，每个size大小的队列</span><span class="token keyword">int</span> <span class="token function">queuelist_init</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span><span class="token operator">*</span> queue<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> len <span class="token operator">&amp;&amp;</span> <span class="token number">0</span> <span class="token operator">==</span> size<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;</span> len <span class="token operator">&amp;&amp;</span> <span class="token number">0</span> <span class="token operator">&lt;</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token operator">*</span>queue <span class="token operator">=</span> <span class="token punctuation">(</span>QueueList<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>QueueList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> <span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"failed while malloc &lt;queuelist>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>mutex_lock<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"failed while MutexCreate\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>queue <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> len <span class="token operator">&amp;&amp;</span> <span class="token number">0</span> <span class="token operator">==</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">=</span> size<span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Node<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token function">node_create</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head <span class="token operator">&amp;&amp;</span> <span class="token constant">NULL</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head <span class="token operator">=</span> node<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail <span class="token operator">=</span> node<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail<span class="token operator">-></span>next <span class="token operator">=</span> node<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail <span class="token operator">=</span> node<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>tail <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//创建节点 size == 0创建buff长度的节点，size> 0创建size长度的节点</span>Node<span class="token operator">*</span> <span class="token function">node_create</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span>Type<span class="token operator">*</span> buff<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Node<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token punctuation">(</span>Node<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> node<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"failed while malloc &lt;node>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> node<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>node<span class="token operator">-></span>buff <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> queue<span class="token operator">-></span>size<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>Type<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>Type<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>node<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>node<span class="token operator">-></span>len <span class="token operator">=</span> len<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">bzero</span><span class="token punctuation">(</span>node<span class="token operator">-></span>buff<span class="token punctuation">,</span>queue<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> node<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">memcpy</span><span class="token punctuation">(</span>node<span class="token operator">-></span>buff<span class="token punctuation">,</span>buff<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> node<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//队列为空</span><span class="token keyword">int</span> <span class="token function">is_qempty</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//perror("queue is NULLL\n");</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//队列满</span><span class="token keyword">int</span> <span class="token function">is_qfull</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"queue is NULL\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"queue type error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>res <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> queue<span class="token operator">-></span>size <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> queue<span class="token operator">-></span>head <span class="token operator">==</span> queue<span class="token operator">-></span>tail <span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//队列字符串个数</span><span class="token keyword">int</span> <span class="token function">queuelist_num</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"queue is NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> queue<span class="token operator">-></span>res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//入队(尾添加)</span><span class="token keyword">int</span> <span class="token function">Push_QueueList</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span>Type<span class="token operator">*</span> buff<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"push fail,queue is NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> buff<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"push fail,buff is NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> queue<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Node<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>node <span class="token operator">=</span> <span class="token function">node_create</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span>buff<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> node<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> queue<span class="token operator">-></span>head<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>queue<span class="token operator">-></span>head <span class="token operator">=</span> node<span class="token punctuation">;</span>queue<span class="token operator">-></span>tail <span class="token operator">=</span> node<span class="token punctuation">;</span>queue<span class="token operator">-></span>res<span class="token operator">++</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>queue<span class="token operator">-></span>tail<span class="token operator">-></span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>queue<span class="token operator">-></span>tail <span class="token operator">=</span> node<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">is_qfull</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"queue full\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">></span> queue<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buff too larger!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">memcpy</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>tail<span class="token operator">-></span>buff<span class="token punctuation">,</span>buff<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>queue<span class="token operator">-></span>tail<span class="token operator">-></span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>queue<span class="token operator">-></span>tail<span class="token operator">=</span>queue<span class="token operator">-></span>tail<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>queue<span class="token operator">-></span>res<span class="token operator">++</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//出队(头删除)</span><span class="token keyword">int</span> <span class="token function">Pop_QueueList</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span>Type<span class="token operator">*</span> buff<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pop fail,queue is NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">is_qempty</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"pop fail,queue is empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>head<span class="token operator">-></span>len <span class="token operator">></span> len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"buff is too samll!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> size<span class="token operator">=</span>queue<span class="token operator">-></span>head<span class="token operator">-></span>len<span class="token punctuation">;</span><span class="token function">memcpy</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span>queue<span class="token operator">-></span>head<span class="token operator">-></span>buff<span class="token punctuation">,</span>queue<span class="token operator">-></span>head<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">memset</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>head<span class="token operator">-></span>buff<span class="token punctuation">,</span><span class="token number">0x0</span><span class="token punctuation">,</span>queue<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>Node<span class="token operator">*</span> node <span class="token operator">=</span> queue<span class="token operator">-></span>head<span class="token punctuation">;</span>queue<span class="token operator">-></span>head<span class="token operator">-></span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>queue<span class="token operator">-></span>head <span class="token operator">=</span> queue<span class="token operator">-></span>head<span class="token operator">-></span>next<span class="token punctuation">;</span>queue<span class="token operator">-></span>res<span class="token operator">--</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>queue<span class="token operator">-></span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> size<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> queue<span class="token operator">-></span>res<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>queue<span class="token operator">-></span>tail<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">free</span><span class="token punctuation">(</span>node<span class="token operator">-></span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> size<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">clean_queuelist</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span> queue<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Type buff<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_qempty</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">Pop_QueueList</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span>buff<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//销毁队列</span><span class="token keyword">int</span> <span class="token function">destroy_queuelist</span><span class="token punctuation">(</span>QueueList<span class="token operator">*</span><span class="token operator">*</span> queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> <span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>Node<span class="token operator">*</span> head_node <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head<span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span>Node<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head<span class="token punctuation">;</span>node <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Node<span class="token operator">*</span> temp <span class="token operator">=</span> node<span class="token punctuation">;</span>node <span class="token operator">=</span> node<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token operator">-></span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>res<span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span><span class="token punctuation">(</span>Node<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>head<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Node<span class="token operator">*</span> temp <span class="token operator">=</span> node<span class="token punctuation">;</span>node <span class="token operator">=</span> node<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token operator">-></span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>res<span class="token operator">--</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>head_node <span class="token operator">==</span> node<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>queue<span class="token punctuation">)</span><span class="token operator">-></span>mutex_lock<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></div></div>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 队列 </tag>
            
            <tag> 环型队列 </tag>
            
            <tag> 链式队列 </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>管脚复用</title>
      <link href="/2021/07/15/guan-jiao-jie-fu-yong/"/>
      <url>/2021/07/15/guan-jiao-jie-fu-yong/</url>
      
        <content type="html"><![CDATA[<h3 id="管脚复用"><a href="#管脚复用" class="headerlink" title="管脚复用"></a>管脚复用</h3><p>管脚复用指一个引脚具有多种功能，可以在不同时刻使用不同的功能(时分复用)，需要通过配置寄存器来开关芯片外部引脚和内部引脚的连接。</p><span id="more"></span><h4 id="引脚内部情况"><a href="#引脚内部情况" class="headerlink" title="引脚内部情况"></a>引脚内部情况</h4><p><img "" class="lazyload placeholder" data-original="/photo/gpio/7.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><table>    <tr>        <td>引脚</td>         <td>寄存器值</td>        <td>引脚功能</td>   </tr>    <tr>        <td rowspan="3">PA1</td>            <td >0x00</td>         <td >GPIO</td>      </tr>    <tr>        <td >0x01</td>        <td >UART_RX</td>        </tr>        <tr>        <td >0x10</td>        <td >PWM</td>        </tr></table><h4 id="设置GPIO模式"><a href="#设置GPIO模式" class="headerlink" title="设置GPIO模式"></a>设置GPIO模式</h4><p>若要将PA1设置成GPIO模式<br>首先，需要查询手册找到PA1的寄存器地址，设地址为<font color='red'> 0x120F0218 </font><br>上表中的类似数据也可以在手册查找，GPIO功能寄存器要设置为0x00。可以直接设置该地址值为0x00。</p><p>有些芯片手册不会直接告诉该引脚的寄存器地址，会告诉你寄存器基地址，这时候要更具手册告诉的<font color='red'>基地址+偏移</font>去设置寄存器<br><img "" class="lazyload placeholder" data-original="/photo/gpio/8.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br><img "" class="lazyload placeholder" data-original="/photo/gpio/9.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>可以看到寄存器基地址为<font color='red'> 0xFE030000 </font>，上图中的引脚要设置为GPIO_0_0使用，就要设置<font color='red'> 0xFE030000 + 0x20基地址偏移后地址上的值 </font>，图中 2..0 是表示该地址下第第0位到第2位，这三位上的数据表示该引脚的复用模式。<br>但是不能直接往<font color='red'> 0xFE030020 </font>地址设置0x0,这样设置会把其他位的值全部置0.<br>因此，先读取<font color='red'> 0xFE030020 </font>地址上的值，假设读出来的值是 0x26fea113。<br>我们要设置的是前面3位设置为0，第0位到第2位占了3位，要将其置0。111B = 0x7,在第0位开始，所以左移 0 位， (0x7 &lt;&lt; 0)。取反~(0x7)即其他位都为1，低3位变0，11111…..111000B。和0x26fea113 进行&amp;运算，就仅仅只会改变低三位的值。<br>0x26fea113 = 00100110111111101010000100010011B</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">0x26fea113</span><span class="token punctuation">;</span>val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x7</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>；<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>得到 val =  0x26fea110<br>将0x26fea110写入寄存器就完成了设置该引脚复用为GPIO_0_0。</p><h4 id="设置X-I2S2-MCLK"><a href="#设置X-I2S2-MCLK" class="headerlink" title="设置X_I2S2_MCLK"></a>设置X_I2S2_MCLK</h4><p>那设置成X_I2S2_MCLK怎么设置呢？<br>设置该复用模式，需要将这寄存器上这三位设置为0x3 = 011B<br>分步来</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">0x26fea113</span><span class="token punctuation">;</span><span class="token comment">//将第三位置0，</span>val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//val = 0010 0110 1111 1110 1010 0001 0001 0011 &amp; 1111 1111 1111 1111 1111 1111 1111 1011</span><span class="token comment">//将第一位第二位置1</span>val <span class="token operator">|=</span> <span class="token number">0x3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//val = 00100110111111101010000100010011 | 0x11</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此时得到的val = 0x26fea113;<br>将0x26fea113写入寄存器就完成了设置该引脚复用为X_I2S2_MCLK。</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式 </tag>
            
            <tag> Gpio </tag>
            
            <tag> 管脚复用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux用户态设置gpio</title>
      <link href="/2021/07/12/linux-yong-hu-tai-she-zhi-gpio/"/>
      <url>/2021/07/12/linux-yong-hu-tai-she-zhi-gpio/</url>
      
        <content type="html"><![CDATA[<h2 id="Linux用户态设置GPIO"><a href="#Linux用户态设置GPIO" class="headerlink" title="Linux用户态设置GPIO"></a>Linux用户态设置GPIO</h2><p>当单独排查或调试某个引脚相关硬件时，如果直接运行app程序，通过代码修改一次运行一次会比较麻烦。<br>这个时候应当单独对该引脚调试，也可避免程序中可能存在未知的地方修改引脚。</p><span id="more"></span><h3 id="一、GPIO操作相关目录以及接口"><a href="#一、GPIO操作相关目录以及接口" class="headerlink" title="一、GPIO操作相关目录以及接口"></a>一、GPIO操作相关目录以及接口</h3><h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><p>/sys/class/gpio/</p><h4 id="export"><a href="#export" class="headerlink" title="export"></a>export</h4><p>用于导出指定编号的引脚，用为GPIO直接使用</p><h4 id="unexport"><a href="#unexport" class="headerlink" title="unexport"></a>unexport</h4><p>删除导出的GPIO</p><h3 id="二、GPIO使用"><a href="#二、GPIO使用" class="headerlink" title="二、GPIO使用"></a>二、GPIO使用</h3><h4 id="进入-sys-class-gpio-目录"><a href="#进入-sys-class-gpio-目录" class="headerlink" title="进入/sys/class/gpio/目录"></a>进入/sys/class/gpio/目录</h4><p>终端输入:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /sys/class/gpio/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/gpio/1.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><h4 id="添加GPIO"><a href="#添加GPIO" class="headerlink" title="添加GPIO"></a>添加GPIO</h4><p>终端输入: </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">30</span> <span class="token operator">></span> <span class="token builtin class-name">export</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/gpio/2.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><p>可以发现目录下出现了一个gpio30，这就代表添加gpio成功了。如果执行后没有添加上，没反应或提示不能添加，表示该gpio已经被作为其他功能使用。</p><h4 id="操作GPIO"><a href="#操作GPIO" class="headerlink" title="操作GPIO"></a>操作GPIO</h4><p>终端输入:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> gpio30<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/gpio/3.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"></p><p>使用ls命令可以查看到进去后目录下的几个文件如上图。</p><h5 id="direction"><a href="#direction" class="headerlink" title="direction"></a>direction</h5><p>设置引脚输出输入方向<br>1、设置输入</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token keyword">in</span> <span class="token operator">></span> direction<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/gpio/4.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>检查是否设置成功</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> direction<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img "" class="lazyload placeholder" data-original="/photo/gpio/5.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>显示为in，则设置输入方向成功</p><p>2、设置输出</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> out <span class="token operator">></span> direction<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>检查是否成功同上</p><h5 id="value"><a href="#value" class="headerlink" title="value"></a>value</h5><p>1、设置高电平</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><font color='red'> 注意 </font> :该设置操作必须要上面输出输入设置为输出才能设置</p><p><img "" class="lazyload placeholder" data-original="/photo/gpio/6.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif"><br>如图，查询得知原来为低电平，value为0，设置后查询得知为1.设置成功。</p><p>2、设置低电平</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token number">0</span> <span class="token operator">></span> value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="note info"><p>当上述操作后如果，设置高电平应当是3.3V，测量电压却远低于3.3V，这个时候就需要直接操作寄存器来查看管脚复用情况，确认是否正确解复用为gpio模式</p></div><p>👇👇👇👇👇<br><a href="https://marysufer.com/2021/07/15/guan-jiao-jie-fu-yong">管脚复用</a><br><a href="https://marysufer.com/2022/06/30/ming-ling-du-xie-ji-cun-qi/">命令读写寄存器</a></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 嵌入式 </tag>
            
            <tag> Gpio </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
